<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>G.R.&#39;s Blog</title>
<link>https://grigolet.github.io/index.html</link>
<atom:link href="https://grigolet.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description>A blog about data analysis, visualization and sometimes cooking.</description>
<image>
<url>https://grigolet.github.io/profile.png</url>
<title>G.R.&#39;s Blog</title>
<link>https://grigolet.github.io/index.html</link>
</image>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Fri, 22 Sep 2023 22:00:00 GMT</lastBuildDate>
<item>
  <title>Display data from a SQL source on the web with Tabulator and FastAPI</title>
  <link>https://grigolet.github.io/posts/tabulator-sql-fastapi/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>At work we have an SQL database containing a list of alarms that are generated by different control systems. We usually receive Email and SMS notifications for that, but it’s not easy to get an overview of all the alarms. We decided then to create a simple web application that wraps the data on the database and allows people from the team to easily access it.</p>
<p>The web application should have the following requirements:</p>
<ul>
<li>The alarms data should only be read, no modifications are required</li>
<li>The alarms data should be loaded with server side pagination, since the number of rows in the DB are ~O(<img src="https://latex.codecogs.com/png.latex?10%5E4">) and I don’t want to load them all on the web page each time the resource is requested</li>
<li>The data should be displayed on a table that allows for custom filtering. The only way to do filtering with server side pagination is for the table to send the filter queries on the backend and do some sort of server side filtering</li>
<li>One of the columns should contains a link that open a page with all the details of the clicked alarm, like in a RESTful resource</li>
</ul>
<section id="alternative-tools" class="level2">
<h2 class="anchored" data-anchor-id="alternative-tools">Alternative tools</h2>
<p>I initially evaluated the possibility of using some dedicated python libraries like <a href="https://streamlit.io/">streamlit</a>, <a href="https://panel.holoviz.org/">panel</a>, <a href="https://wave.h2o.ai/">h2o-wave</a>, <a href="https://dash.plotly.com/">plotly’s dash</a>, each one with its set of pros and cons. I finally decided to not use them because I felt that although using a data table is pretty easy (panel and dash support the use of tabulator for example), the server side pagination and filtering was a bit cumbersome. In addition, integrating the application with a python ASGI server and adding an endpoints returning a custom response started to look a bit too complicated to the point that implementing it with HTML and vanilla js seemed the easiest and fastest solution to me.</p>
<p>I have also considered few no-code or low-code tools that wrap any data around a web application. I have considered Apache’s <a href="https://superset.apache.org/">superset</a> which is a very powerful tool but it was probably an overkill and I found a bit difficult to configure a main dashboard homepage as well as a dedicated endpoint. I have also thought about using <a href="https://directus.io/">directus</a> which works pretty ok but it adds metadata tables on your db and the filtering on the frontend is a bit cumbersome.</p>
<p>I ultimately decided to invest some time and go back to the basics of python web frameworks and vanilla javascript libraries. In the past I used <a href="https://fastapi.tiangolo.com/tutorial/query-params/">FastAPI</a> for a RESTful web application and I found it quite enjoyable, especially for its clear and extensive documentation. Since the project partially requires to serve data with HTTP Json requests and responses I decided to go for it and use it again.</p>
<p>On the frontend I started googling for javascript data tables. I also saw that streamlit had a plugin for <a href="https://www.ag-grid.com/">AgGrid</a> which seemed like an extremely powerful library but that requires a quite pricy license, so I decided to discard it. Some other options included <a href="https://datatables.net/">DataTables</a> and <a href="https://gridjs.io/">GridJs</a> but I ultimately ended up trying <a href="https://tabulator.info/">Tabulator</a> because it seemed to provide all the required features, it has a nice documentation and the set of examples it provided were pretty clear to me.</p>
</section>
</section>
<section id="setting-up-the-project" class="level1">
<h1>Setting up the project</h1>
<p>In this section I will detail the steps I’ve taken to create the web project. You can also have a look at the final example at the <a href="https://github.com/grigolet/tabulator-sql-fastapi-demo">demo repo on github</a> for the final result.</p>
<p><strong>DISCLAIMER</strong> <em>I am not a web developer, I mainly work with gas systems and particle detectors. As such, my code may not be entirely safe and optimized for needs other than mine. Read, learn and use at your own risk 🤌</em></p>
<p>First thing, create a dedicated folder in which you can install your python virtual environment and application.</p>
<div class="sourceCode" id="cb1" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> tabulator-sql-fastapi-demo </span></code></pre></div>
<p>We will work inside the <code>tabulator-sql-fastapi-demo</code> folder from now on. Create a virtual environment and activate it</p>
<div class="sourceCode" id="cb2" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> tabulator-sql-fastapi-demo </span></code></pre></div>
<div class="sourceCode" id="cb3" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-m</span> venv venv</span></code></pre></div>
<div class="sourceCode" id="cb4" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">source</span> venv/bin/activate</span></code></pre></div>
<p>Create an <code>app</code> folder where we will put our code</p>
<div class="sourceCode" id="cb5" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> app</span></code></pre></div>
<p>Let’s create a <code>requirements.txt</code> file and start putting FastAPI with all the optional dependencies:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>requirements.txt</strong></pre>
</div>
<div class="sourceCode" id="cb6" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource text number-lines code-with-copy"><code class="sourceCode"><span id="cb6-1">fastapi[all]</span></code></pre></div>
</div>
</section>
<section id="creating-the-initial-backend" class="level1">
<h1>Creating the initial backend</h1>
<p>Let’s start by creating a server with three endpoints: a main one served on <code>/</code>, one called <code>/alarm</code> which will serve as a resource for a single alarm and an <code>/alarms</code> one which will serve multiple alarms</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="cb7" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastapi <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FastAPI, Request</span>
<span id="cb7-2"></span>
<span id="cb7-3">app <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FastAPI()</span>
<span id="cb7-4"></span>
<span id="cb7-5"></span>
<span id="cb7-6"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@app.get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>)</span>
<span id="cb7-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> home(request: Request):</span>
<span id="cb7-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"page"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"home"</span>}</span>
<span id="cb7-9"></span>
<span id="cb7-10"></span>
<span id="cb7-11"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@app.get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarm"</span>)</span>
<span id="cb7-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> home(request: Request):</span>
<span id="cb7-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"page"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alarm"</span>}</span>
<span id="cb7-14"></span>
<span id="cb7-15"></span>
<span id="cb7-16"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@app.get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarms"</span>)</span>
<span id="cb7-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> home(request: Request):</span>
<span id="cb7-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"page"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alarms"</span>}</span></code></pre></div>
</div>
<p>Run the main application:</p>
<div class="sourceCode" id="cb8" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">uvicorn</span> app.main:app <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">--reload</span></span></code></pre></div>
<p>If you open your web browser at the link mentioned by <code>uvicorn</code> you should get the json response for each of the endpoint defined, e.g.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>http://127.0.0.1:8000/alarms</strong></pre>
</div>
<div class="sourceCode" id="cb9" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb9-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"page"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alarms"</span></span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</div>
<section id="create-a-database-and-populate-it-with-some-data" class="level2">
<h2 class="anchored" data-anchor-id="create-a-database-and-populate-it-with-some-data">Create a database and populate it with some data</h2>
<p>For simplicity I am going to use sqlite, but any popular SQL database should work fine. Note that I am not using any ORM to keep it as simple as possible. In this example, the database will consists of a single table <code>alarms</code> with the following columns:</p>
<ul>
<li><code>id</code></li>
<li><code>system</code></li>
<li><code>timestamp</code></li>
<li><code>category</code></li>
<li><code>text</code></li>
</ul>
<p>We can create a file in the <code>app</code> folder to insert some simple synthetic data:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/db.py</strong></pre>
</div>
<div class="sourceCode" id="cb10" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sqlite3</span>
<span id="cb10-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb10-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datetime <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datetime, timedelta</span>
<span id="cb10-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sys</span>
<span id="cb10-5"></span>
<span id="cb10-6"></span>
<span id="cb10-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> create_db(db: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, table: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>):</span>
<span id="cb10-8">    conn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(db)</span>
<span id="cb10-9">    cur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conn.cursor()</span>
<span id="cb10-10">    cur.execute(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"DROP TABLE IF EXISTS </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">;"</span>)</span>
<span id="cb10-11">    cur.execute(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""CREATE TABLE </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>table<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">(</span></span>
<span id="cb10-12"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        id integer primary key autoincrement, </span></span>
<span id="cb10-13"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">        system, timestamp DATETIME, category, text);"""</span>)</span>
<span id="cb10-14">    conn.commit()</span></code></pre></div>
</div>
<p>The function above will create a table <code>alarms</code> on the provided sqlite db filepath. Next, we can create a function to generate data</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/db.py</strong></pre>
</div>
<div class="sourceCode" id="cb11" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">...</span>
<span id="cb11-2"></span>
<span id="cb11-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> generate_data(n: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb11-4">    systems <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ALITPC"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ALITRD"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ALITOF"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATLRPC"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATLTGC"</span>, </span>
<span id="cb11-5">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ATLMDT"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CMSDT"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CMSRPC"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CMSCSC"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LHBRI1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LHBRI2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LHBMWP"</span>]</span>
<span id="cb11-6">    categories <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unProcessAlarm"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unProcessWarning"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PLCAlarm"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PGSAlarm"</span>]</span>
<span id="cb11-7">    messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value outside range"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bad Communication"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Connection issues"</span>]</span>
<span id="cb11-8">    now <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.now()</span>
<span id="cb11-9">    last_year <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> now <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> timedelta(days<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">365</span>)</span>
<span id="cb11-10">    random_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb11-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb11-12">        random_system <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> random.choice(systems)</span>
<span id="cb11-13">        random_category <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> random.choice(categories)</span>
<span id="cb11-14">        random_epoch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> random.randrange(</span>
<span id="cb11-15">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(last_year.timestamp()), <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(now.timestamp())</span>
<span id="cb11-16">        )</span>
<span id="cb11-17">        random_timestamp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datetime.fromtimestamp(random_epoch)</span>
<span id="cb11-18">        random_messages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> random.choice(messages)</span>
<span id="cb11-19">        random_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"""</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>random_timestamp<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>random_system<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>random_category<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> - </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>random_messages<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb11-20">        random_data.append(</span>
<span id="cb11-21">            (random_system, random_timestamp, random_category, random_text)</span>
<span id="cb11-22">        )</span>
<span id="cb11-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> random_data</span></code></pre></div>
</div>
<p>This function is randomly sampling from a sequence of items to create unique rows. Also, a random timestamp is created by selecting a random value of epoch seconds between the current timestamp and the timestamp - 365 days.</p>
<p>We can then make a small function to insert the data in the database</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/db.py</strong></pre>
</div>
<div class="sourceCode" id="cb12" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">...</span>
<span id="cb12-2"></span>
<span id="cb12-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> insert_data(db: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, table: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>, data: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">tuple</span>]):</span>
<span id="cb12-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Insert data in the table"""</span></span>
<span id="cb12-5">    conn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(db)</span>
<span id="cb12-6">    cur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conn.cursor()</span>
<span id="cb12-7">    cur.executemany(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"INSERT INTO alarms VALUES (NULL, ?, ?, ?, ?)"</span>, data)</span>
<span id="cb12-8">    conn.commit()</span>
<span id="cb12-9">    cur.close()</span>
<span id="cb12-10">    conn.close()</span></code></pre></div>
</div>
<p>Note that I have placed <code>NULL</code> because I let the <code>id</code> column autoincrement by itself.</p>
<p>Finally, we can put the pieces together and run all the functions:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/db.py</strong></pre>
</div>
<div class="sourceCode" id="cb13" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">...</span>
<span id="cb13-2"></span>
<span id="cb13-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">__name__</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"__main__"</span>:</span>
<span id="cb13-4">    random_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_data(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10_000</span>)</span>
<span id="cb13-5">    create_db(db<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"db.sqlite"</span>, table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alarms"</span>)</span>
<span id="cb13-6">    insert_data(db<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"db.sqlite"</span>, table<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alarms"</span>, data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>random_data)</span></code></pre></div>
</div>
<p>The database can be filled by calling the <code>db.py</code> file:</p>
<div class="sourceCode" id="cb14" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">cd</span> app <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="ex" style="color: null;
background-color: null;
font-style: inherit;">python</span> db.py</span></code></pre></div>
<p>We can verify that the <code>alarms</code> table is filled by running a simple query using the <code>sqlite3</code> cli:</p>
<div class="sourceCode" id="cb15" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">$</span> sqlite3 db.sqlite <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-cmd</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".headers on"</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM alarms LIMIT 5"</span></span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">id</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">system</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">timestamp</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">category</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">text</span></span>
<span id="cb15-3"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">1</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ATLTGC</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2023-02-19</span> 10:05:04<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">unProcessWarning</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2023-02-19</span> 10:05:04 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> ATLTGC <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> unProcessWarning <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> Connection issues</span>
<span id="cb15-4"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">LHBRI2</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2023-01-18</span> 19:44:03<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">unProcessWarning</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2023-01-18</span> 19:44:03 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> LHBRI2 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> unProcessWarning <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> Value outside range</span>
<span id="cb15-5"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">3</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">ALITPC</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2023-07-17</span> 00:46:08<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">PLCAlarm</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2023-07-17</span> 00:46:08 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> ALITPC <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> PLCAlarm <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> Bad Communication</span>
<span id="cb15-6"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">4</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">CMSCSC</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2023-01-18</span> 03:57:57<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">unProcessWarning</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2023-01-18</span> 03:57:57 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> CMSCSC <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> unProcessWarning <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> Bad Communication</span>
<span id="cb15-7"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">5</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">CMSRPC</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2022-12-05</span> 04:28:17<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">PLCAlarm</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">|</span><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">2022-12-05</span> 04:28:17 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> CMSRPC <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> PLCAlarm <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">-</span> Value outside range</span></code></pre></div>
</section>
<section id="sharing-the-app-settings-and-database-connection" class="level2">
<h2 class="anchored" data-anchor-id="sharing-the-app-settings-and-database-connection">Sharing the app settings and database connection</h2>
<p>Before implementing the endpoints, it should be noted that the database could be accessed by different users and through different sessions. We could create a single session for the db that will get reused by the different server connections. In FastAPI, one can do this through its dependency injection system. First, we can create a class representing the settings to connect to the db:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="cb16" data-code-line-numbers="4,8,9,10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastapi <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FastAPI, Request, Query, Depends</span>
<span id="cb16-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Annotated</span>
<span id="cb16-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sqlite3</span>
<span id="cb16-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic_settings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseSettings, SettingsConfigDict </span>
<span id="cb16-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb16-6"></span>
<span id="cb16-7"></span>
<span id="cb16-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Settings(BaseSettings): </span>
<span id="cb16-9">    model_config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SettingsConfigDict(env_file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>) </span>
<span id="cb16-10">    db_path: Path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'app/db.sqlite'</span> </span>
<span id="cb16-11"></span>
<span id="cb16-12"></span>
<span id="cb16-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_settings():</span>
<span id="cb16-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> Settings()</span>
<span id="cb16-15"></span>
<span id="cb16-16"></span>
<span id="cb16-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_db(settings: Annotated[Settings, Depends(get_settings)]): </span>
<span id="cb16-18">    conn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(settings.db_path) </span>
<span id="cb16-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>: </span>
<span id="cb16-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> conn </span>
<span id="cb16-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">finally</span>: </span>
<span id="cb16-22">        conn.close() </span></code></pre></div>
</div>
<p>This class is based on pydantics and will allow to read the database from an <code>.env</code> file or environmental variable <code>DB_PATH</code>. By default we put <code>db.sqlite</code>, but pydantic will also check that the path is a valid path since we defined its type to be a python’s <code>pathlib.Path</code>.</p>
<p>Then, we can create a dependency function that will yield our settings. This is the mechanism that FastAPI uses to defined dependencies that will be reused throughout the application.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="cb17" data-code-line-numbers="13,14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastapi <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FastAPI, Request, Query, Depends</span>
<span id="cb17-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Annotated</span>
<span id="cb17-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sqlite3</span>
<span id="cb17-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic_settings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseSettings, SettingsConfigDict </span>
<span id="cb17-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb17-6"></span>
<span id="cb17-7"></span>
<span id="cb17-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Settings(BaseSettings): </span>
<span id="cb17-9">    model_config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SettingsConfigDict(env_file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>) </span>
<span id="cb17-10">    db_path: Path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'app/db.sqlite'</span></span>
<span id="cb17-11"></span>
<span id="cb17-12"></span>
<span id="cb17-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_settings(): </span>
<span id="cb17-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> Settings() </span>
<span id="cb17-15"></span>
<span id="cb17-16"></span>
<span id="cb17-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_db(settings: Annotated[Settings, Depends(get_settings)]): </span>
<span id="cb17-18">    conn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(settings.db_path) </span>
<span id="cb17-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>: </span>
<span id="cb17-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> conn </span>
<span id="cb17-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">finally</span>: </span>
<span id="cb17-22">        conn.close() </span></code></pre></div>
</div>
<p>Finally, we create another dependency, which will return the connection object to the database:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="cb18" data-code-line-numbers="17,18,19,20,21,22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastapi <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FastAPI, Request, Query, Depends</span>
<span id="cb18-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Annotated</span>
<span id="cb18-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sqlite3</span>
<span id="cb18-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic_settings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseSettings, SettingsConfigDict </span>
<span id="cb18-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb18-6"></span>
<span id="cb18-7"></span>
<span id="cb18-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Settings(BaseSettings): </span>
<span id="cb18-9">    model_config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SettingsConfigDict(env_file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>) </span>
<span id="cb18-10">    db_path: Path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'app/db.sqlite'</span></span>
<span id="cb18-11"></span>
<span id="cb18-12"></span>
<span id="cb18-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_settings():</span>
<span id="cb18-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> Settings()</span>
<span id="cb18-15"></span>
<span id="cb18-16"></span>
<span id="cb18-17"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_db(settings: Annotated[Settings, Depends(get_settings)]): </span>
<span id="cb18-18">    conn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(settings.db_path) </span>
<span id="cb18-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>: </span>
<span id="cb18-20">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> conn </span>
<span id="cb18-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">finally</span>: </span>
<span id="cb18-22">        conn.close() </span></code></pre></div>
</div>
<p>You can read more about dependency injection on <a href="https://fastapi.tiangolo.com/tutorial/dependencies/">FastAPI documentation</a> but from my understanding the <code>get_db</code> is a dependency that requires another dependency and declares it by using the <code>Depends</code> function.</p>
</section>
<section id="implementing-the-endpoints" class="level2">
<h2 class="anchored" data-anchor-id="implementing-the-endpoints">Implementing the endpoints</h2>
<p>We now want to be able to fetch the database rows from the <code>/alarm</code> endpoint and the <code>/alarms</code> one. The <code>/alarm</code> endpoint should have a mandatory query parameter which will be the <code>id</code>. The <code>/alarms</code> should instead support pagination, i.e.&nbsp;it should be able to receive two parameters <code>page</code>, which should indicate which page we want to retrieve and <code>size</code> which indicates the amount of rows per page.</p>
<p>In the <code>main.py</code>, the endpoint for <code>/alarm</code> would look like this:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-19" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource python code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode python"><button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="1">1</button><span id="annotated-cell-19-1" class="code-annotation-target"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@app.get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarm"</span>)</span>
<span id="annotated-cell-19-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> alarm(</span>
<span id="annotated-cell-19-3">    request: Request, </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="2">2</button><span id="annotated-cell-19-4" class="code-annotation-target">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, Query()],</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="3">3</button><span id="annotated-cell-19-5" class="code-annotation-target">    db: sqlite3.Connection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Depends(get_db),</span>
<span id="annotated-cell-19-6">):</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="4">4</button><span id="annotated-cell-19-7" class="code-annotation-target">    db.row_factory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.Row</span>
<span id="annotated-cell-19-8">    cursor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.cursor()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="5">5</button><span id="annotated-cell-19-9" class="code-annotation-target">    cursor.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM alarms WHERE id = ?"</span>, (<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>, ))</span>
<span id="annotated-cell-19-10">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchone()</span>
<span id="annotated-cell-19-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> result</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-19" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="1" data-code-annotation="1">I defined a GET endpoint for <code>/alarms</code></span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="4" data-code-annotation="2">I’m telling FastAPI that id should be an <code>int</code> and a query parameter (passed through ‘?id=…’ on the url)</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="5" data-code-annotation="3">The db object is the dependency that I have explained earlier</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="7" data-code-annotation="4">By default the rows will be returned as a list of tuples but I wanted to return a list of <code>dict</code> where the keys are the column names.</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="9" data-code-annotation="5">I am passing a query, selecting by id and using a placeholder to bind external values</span>
</dd>
</dl>
<p>Moving now to the <code>/alarms</code> endpoint, this will be a bit more sophisticated: <a href="https://tabulator.info/docs/5.5/page#remote-response">in order to prepare the data to be consumed by Tabulator</a> we would need to accept the size of a page <code>size</code>, the number of the page we want to get <code>page</code>, and we should return a json with one key called <code>last_page</code> indicating the total number of pages and one key called <code>data</code> with the returned data. The code looks like this:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-20" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource python code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-20-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@app.get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarms"</span>)</span>
<span id="annotated-cell-20-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> home(</span>
<span id="annotated-cell-20-3">    request: Request,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="1">1</button><span id="annotated-cell-20-4" class="code-annotation-target">    page: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, Query(ge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="annotated-cell-20-5">    size: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, Query(lt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="annotated-cell-20-6">    db: sqlite3.Connection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Depends(get_db) </span>
<span id="annotated-cell-20-7">):</span>
<span id="annotated-cell-20-8">    db.row_factory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.Row</span>
<span id="annotated-cell-20-9">    cursor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.cursor()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="2">2</button><span id="annotated-cell-20-10" class="code-annotation-target">    offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (page <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> size</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="3">3</button><span id="annotated-cell-20-11" class="code-annotation-target">    cursor.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT COUNT(id) FROM alarms"</span>)</span>
<span id="annotated-cell-20-12">    n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchone()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="4">4</button><span id="annotated-cell-20-13" class="code-annotation-target">    n_pages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> size <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="annotated-cell-20-14">    </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-20" data-target-annotation="5">5</button><span id="annotated-cell-20-15" class="code-annotation-target">    cursor.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM alarms LIMIT ? OFFSET ?"</span>, (size, offset))</span>
<span id="annotated-cell-20-16">    alarms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchall()</span>
<span id="annotated-cell-20-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {</span>
<span id="annotated-cell-20-18">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'last_page'</span>: n_pages,</span>
<span id="annotated-cell-20-19">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data'</span>: alarms </span>
<span id="annotated-cell-20-20">    }</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-20" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="4,5" data-code-annotation="1"><code>page</code> is a query parameter from a GET request. I’ve put the constraint that it should be always greater or equal than 1 <code>ge=1</code>. Similarly, <code>size</code> is a query parameter and I’ve put a constraint on the maximum number of items that can be requested</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="10" data-code-annotation="2">I’m computing an offset that will be used by the SQL query to get the paginated rows</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="11" data-code-annotation="3">Tabulator needs the total number of page so we need to count how many rows we have in the table</span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="13" data-code-annotation="4">The number of pages depends on the number of rows and on the size of the page. Remember to add one for the remainder rows from the division <code>n_rows/size</code></span>
</dd>
<dt data-target-cell="annotated-cell-20" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-20" data-code-lines="15" data-code-annotation="5">I’m selecting the alarms with <code>size</code> and <code>offset</code></span>
</dd>
</dl>
<p>If you look now what you get at <code>localhost:8000/alarms</code> you would see something like:</p>
<div class="sourceCode" id="cb19" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb19-1"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">//</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">http://127.0.0.1:8000/alarms</span></span>
<span id="cb19-2"></span>
<span id="cb19-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span></span>
<span id="cb19-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"last_page"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"data"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb19-6">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span></span>
<span id="cb19-7">      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-8">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CMSCSC"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-9">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-08-28 12:02:43"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-10">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"unProcessWarning"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb19-11">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-08-28 12:02:43 - CMSCSC - unProcessWarning - Bad Communication"</span></span>
<span id="cb19-12">    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">],</span></span>
<span id="cb19-13">    <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">//</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">...</span></span>
<span id="cb19-14"><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
</section>
<section id="setting-up-tabulator" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-tabulator">Setting up tabulator</h2>
<p>Now we can create a home page and setting up tabulator. We can start by defining an <code>index.html</code> file which will be returned by FastAPI when visiting <code>/</code>. We can create the file inside a <code>templates</code> folder and serve it as a <code>jinja</code> template in case we would need to add some custom logic later.</p>
<ul>
<li>Create the templates folder:</li>
</ul>
<div class="sourceCode" id="cb20" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource sh number-lines code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mkdir</span> app/templates</span></code></pre></div>
<ul>
<li>Add and <code>index.html</code> file inside the folder:</li>
</ul>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/templates/index.html</strong></pre>
</div>
<div class="sourceCode" id="cb21" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource html number-lines code-with-copy"><code class="sourceCode html"><span id="cb21-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;!DOCTYPE </span>html<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb21-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;html&gt;</span></span>
<span id="cb21-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;head&gt;</span></span>
<span id="cb21-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;title&gt;</span>Alarms<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/title&gt;</span></span>
<span id="cb21-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;style&gt;</span></span>
<span id="cb21-6">        body {</span>
<span id="cb21-7">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">font-family</span>: Arial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">sans-serif</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-8">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-9">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-10">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">background-color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#f0f0f0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-11">        }</span>
<span id="cb21-12">        h1 {</span>
<span id="cb21-13">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#333</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-14">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">text-align</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">center</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-15">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">px</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb21-16">        }</span>
<span id="cb21-17">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/style&gt;</span></span>
<span id="cb21-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/head&gt;</span></span>
<span id="cb21-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;body&gt;</span></span>
<span id="cb21-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;h1&gt;</span>Alarms list<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/h1&gt;</span></span>
<span id="cb21-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;div</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">id</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alarms-table"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/div&gt;</span></span>
<span id="cb21-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/body&gt;</span></span>
<span id="cb21-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/html&gt;</span></span></code></pre></div>
</div>
<p>I have added a bare minimum amount of CSS to have a gray background and the title centered. We can now serve the file from FastAPI. To do so, we need to change the <code>main.py</code> file</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="cb22" data-code-line-numbers="2,27,30,31,32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastapi <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FastAPI, Request, Query, Depends, Body</span>
<span id="cb22-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastapi.templating <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Jinja2Templates </span>
<span id="cb22-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Annotated</span>
<span id="cb22-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sqlite3</span>
<span id="cb22-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pydantic_settings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> BaseSettings, SettingsConfigDict</span>
<span id="cb22-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb22-7"></span>
<span id="cb22-8"></span>
<span id="cb22-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> Settings(BaseSettings):</span>
<span id="cb22-10">    model_config <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SettingsConfigDict(env_file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".env"</span>)</span>
<span id="cb22-11">    db_path: Path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"app/db.sqlite"</span></span>
<span id="cb22-12"></span>
<span id="cb22-13"></span>
<span id="cb22-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_settings():</span>
<span id="cb22-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> Settings()</span>
<span id="cb22-16"></span>
<span id="cb22-17"></span>
<span id="cb22-18"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_db(settings: Annotated[Settings, Depends(get_settings)]):</span>
<span id="cb22-19">    conn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.<span class="ex" style="color: null;
background-color: null;
font-style: inherit;">connect</span>(settings.db_path)</span>
<span id="cb22-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">try</span>:</span>
<span id="cb22-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">yield</span> conn</span>
<span id="cb22-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">finally</span>:</span>
<span id="cb22-23">        conn.close()</span>
<span id="cb22-24"></span>
<span id="cb22-25"></span>
<span id="cb22-26">app <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FastAPI()</span>
<span id="cb22-27">templates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Jinja2Templates(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'app/templates'</span>) </span>
<span id="cb22-28"></span>
<span id="cb22-29"></span>
<span id="cb22-30"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@app.get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>) </span>
<span id="cb22-31"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> home(request: Request): </span>
<span id="cb22-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> templates.TemplateResponse(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'index.html'</span>, context<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'request'</span>: request}) </span>
<span id="cb22-33"></span>
<span id="cb22-34">...</span></code></pre></div>
</div>
<p>Here we created a <code>templates</code> object that is using Jinja2 to render the files inside the <code>app/templates</code> folder. Note that for each <code>TemplateResponse</code> you need to pass a context object with the request.</p>
<p>We can now work on the <code>index.html</code> file by importing tabulator from a CDN and creating the Javascript object by refering to the documentation on <a href="https://tabulator.info/docs/5.5/data#ajax">loading AJAX data</a> and on <a href="https://tabulator.info/docs/5.5/page#remote">setting server side pagination</a>:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/index.html</strong></pre>
</div>
<div class="sourceCode" id="cb23" data-source-line-numbers="17-19,28-36" data-code-line-numbers="17-19,28-36" style="background: #f1f3f5;"><pre class="sourceCode numberSource html number-lines code-with-copy"><code class="sourceCode html"><span id="cb23-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;!DOCTYPE </span>html<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb23-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;html&gt;</span></span>
<span id="cb23-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;head&gt;</span></span>
<span id="cb23-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;title&gt;</span>Alarms<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/title&gt;</span></span>
<span id="cb23-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;style&gt;</span></span>
<span id="cb23-6">        body {</span>
<span id="cb23-7">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">font-family</span>: Arial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">sans-serif</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-8">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-9">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-10">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">background-color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#f0f0f0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-11">        }</span>
<span id="cb23-12">        h1 {</span>
<span id="cb23-13">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#333</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-14">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">text-align</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">center</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-15">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">px</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-16">        }</span>
<span id="cb23-17">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#alarms-table</span> {</span>
<span id="cb23-18">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">rem</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb23-19">        }</span>
<span id="cb23-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/style&gt;</span></span>
<span id="cb23-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;link</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">href</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">rel</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stylesheet"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb23-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;script</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text/javascript"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">src</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/script&gt;</span></span>
<span id="cb23-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/head&gt;</span></span>
<span id="cb23-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;body&gt;</span></span>
<span id="cb23-25">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;h1&gt;</span>Alarms list<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/h1&gt;</span></span>
<span id="cb23-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;div</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">id</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alarms-table"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/div&gt;</span></span>
<span id="cb23-27">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;script&gt;</span></span>
<span id="cb23-28">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tabulator</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#alarms-table"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb23-29">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">layout</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fitDataStretch'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb23-30">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxURL</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarms"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb23-31">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxContentType</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'json'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb23-32">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxConfig</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'GET'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb23-33">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">pagination</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb23-34">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">paginationMode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remote"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb23-35">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">autoColumns</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb23-36">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">paginationSize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> </span>
<span id="cb23-37">        })</span>
<span id="cb23-38">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/script&gt;</span></span>
<span id="cb23-39"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/body&gt;</span></span>
<span id="cb23-40"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/html&gt;</span></span></code></pre></div>
</div>
<p>Few things to note here:</p>
<ol type="1">
<li>Pagination must be enabled and set to remote. If not, tabulator will expect the <code>ajaxURL</code> to provide an array of records.</li>
<li>Setting <code>autoColumns</code> is needed if you don’t want to define the column by yourself.</li>
</ol>
<p>This is what my web page look like:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/tabulator-sql-fastapi/initial_table.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Home page with tabulator loading data from a DB</figcaption>
</figure>
</div>
</section>
<section id="adding-server-side-filtering" class="level2">
<h2 class="anchored" data-anchor-id="adding-server-side-filtering">Adding server side filtering</h2>
<p>Tabulator allows to have some filters on the header of each column. A query is sent to the <code>ajaxURL</code> in the form of an array. We should also change the method from <code>GET</code> to <code>POST</code>, as I had a hard-time trying to pass URL-encoded lists to FastAPI and get it parsed as query parameters, so a body parameter is more adequate. Let’s enable header filters:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/index.html</strong></pre>
</div>
<div class="sourceCode" id="cb24" data-source-line-numbers="31,32,36-39" data-code-line-numbers="31,32,36-39" style="background: #f1f3f5;"><pre class="sourceCode numberSource html number-lines code-with-copy"><code class="sourceCode html"><span id="cb24-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;!DOCTYPE </span>html<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb24-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;html&gt;</span></span>
<span id="cb24-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;head&gt;</span></span>
<span id="cb24-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;title&gt;</span>Alarms<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/title&gt;</span></span>
<span id="cb24-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;style&gt;</span></span>
<span id="cb24-6">        body {</span>
<span id="cb24-7">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">font-family</span>: Arial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">sans-serif</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-8">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-9">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-10">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">background-color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#f0f0f0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-11">        }</span>
<span id="cb24-12">        h1 {</span>
<span id="cb24-13">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#333</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-14">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">text-align</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">center</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-15">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">px</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-16">        }</span>
<span id="cb24-17">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#alarms-table</span> {</span>
<span id="cb24-18">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">rem</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb24-19">        }</span>
<span id="cb24-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/style&gt;</span></span>
<span id="cb24-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;link</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">href</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">rel</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stylesheet"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb24-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;script</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text/javascript"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">src</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/script&gt;</span></span>
<span id="cb24-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/head&gt;</span></span>
<span id="cb24-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;body&gt;</span></span>
<span id="cb24-25">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;h1&gt;</span>Alarms list<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/h1&gt;</span></span>
<span id="cb24-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;div</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">id</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alarms-table"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/div&gt;</span></span>
<span id="cb24-27">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;script&gt;</span></span>
<span id="cb24-28">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tabulator</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#alarms-table"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb24-29">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">layout</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fitDataStretch'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb24-30">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxURL</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarms"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb24-31">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxContentType</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'json'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb24-32">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxConfig</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'POST'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb24-33">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">pagination</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb24-34">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">paginationMode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remote"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb24-35">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">paginationSize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb24-36">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">filterMode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'remote'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb24-37">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">autoColumns</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb24-38">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">autoColumnsDefinitions</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> [</span>
<span id="cb24-39">                {<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">field</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Text'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">headerFilter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>}</span>
<span id="cb24-40">            ]</span>
<span id="cb24-41">        })</span>
<span id="cb24-42">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/script&gt;</span></span>
<span id="cb24-43"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/body&gt;</span></span>
<span id="cb24-44"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/html&gt;</span></span></code></pre></div>
</div>
<p>And update the code in the <code>main.py</code> file</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="cb25" data-code-line-numbers="1,5,8,9,11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastapi <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FastAPI, Request, Query, Depends, Body </span>
<span id="cb25-2"></span>
<span id="cb25-3">...</span>
<span id="cb25-4"></span>
<span id="cb25-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@app.post</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarms"</span>) </span>
<span id="cb25-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> home(</span>
<span id="cb25-7">    request: Request,</span>
<span id="cb25-8">    page: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, Body(ge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb25-9">    size: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, Body(lt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, </span>
<span id="cb25-10">    db: sqlite3.Connection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Depends(get_db), </span>
<span id="cb25-11">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>], Body()] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span> </span>
<span id="cb25-12">):</span>
<span id="cb25-13">    db.row_factory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.Row</span>
<span id="cb25-14">    cursor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.cursor()</span>
<span id="cb25-15">    offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (page <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> size</span>
<span id="cb25-16">    cursor.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT COUNT(id) as count FROM alarms"</span>)</span>
<span id="cb25-17">    n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchone()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>]</span>
<span id="cb25-18">    n_pages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> size <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb25-19">    </span>
<span id="cb25-20">    cursor.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM alarms LIMIT ? OFFSET ?"</span>, (size, offset))</span>
<span id="cb25-21">    alarms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchall()</span>
<span id="cb25-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {</span>
<span id="cb25-23">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'last_page'</span>: n_pages,</span>
<span id="cb25-24">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data'</span>: alarms </span>
<span id="cb25-25">    }</span></code></pre></div>
</div>
<p>If you inspect the request from the developer console, you would see that when typing something in the <code>text</code> this json payload is sent:</p>
<div class="sourceCode" id="cb26" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"filter"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">[</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">{</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"field"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"type"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"like"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"value"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rpc"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">]</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"page"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">,</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">"size"</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">}</span></span></code></pre></div>
<p>The filter key contains a list of filters, each one for a set of condition that we can use to filter the data on our db. In particular, the <code>field</code> key refers to the column of the table, the <code>type</code> is the operator used and <code>value</code> is the value typed in in the header input. We should only be careful about possible SQL injections. For this reason</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="annotated-cell-29" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource python code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-29-1"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@app.post</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarms"</span>)</span>
<span id="annotated-cell-29-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> home(</span>
<span id="annotated-cell-29-3">    request: Request,</span>
<span id="annotated-cell-29-4">    page: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, Body(ge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="annotated-cell-29-5">    size: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, Body(lt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="annotated-cell-29-6">    db: sqlite3.Connection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Depends(get_db), </span>
<span id="annotated-cell-29-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>], Body()] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="annotated-cell-29-8">):</span>
<span id="annotated-cell-29-9">    db.row_factory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.Row</span>
<span id="annotated-cell-29-10">    cursor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.cursor()</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="1">1</button><span id="annotated-cell-29-11" class="code-annotation-target">    where_clauses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="annotated-cell-29-12">    where_query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="annotated-cell-29-13">    placeholder_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="annotated-cell-29-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>):  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply a WHERE clause in the SQL query</span></span>
<span id="annotated-cell-29-15">        where_query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" WHERE "</span></span>
<span id="annotated-cell-29-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> filter_obj <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>:</span>
<span id="annotated-cell-29-17">            field, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>, value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> filter_obj[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'field'</span>], filter_obj[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>], filter_obj[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>]</span>
<span id="annotated-cell-29-18">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check that the filter field can be trusted and exists as a column in our table</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="2">2</button><span id="annotated-cell-29-19" class="code-annotation-target">            cursor.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"select name from PRAGMA_TABLE_INFO('alarms') where name = ?"</span>, (field,))</span>
<span id="annotated-cell-29-20">            column_field <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchone()</span>
<span id="annotated-cell-29-21">            operand <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>.upper()</span>
<span id="annotated-cell-29-22">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> column_field:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the filter field exists as a column</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="3">3</button><span id="annotated-cell-29-23" class="code-annotation-target">                <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">match</span> operand:</span>
<span id="annotated-cell-29-24">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">case</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LIKE'</span>: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if using like as tabulator mention, add wildcards</span></span>
<span id="annotated-cell-29-25">                        placeholder_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'%</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%'</span></span>
<span id="annotated-cell-29-26">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">case</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'='</span>:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this is mostly used for numerical, categorical or date filtering</span></span>
<span id="annotated-cell-29-27">                        placeholder_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value</span>
<span id="annotated-cell-29-28">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">case</span> other:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the operand is not supported, return an HTTP 400 response</span></span>
<span id="annotated-cell-29-29">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> HTTPException(status_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>, detail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Filter type </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>operand<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> not supported."</span>)</span>
<span id="annotated-cell-29-30">    </span>
<span id="annotated-cell-29-31">                where_clauses.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>column_field[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>operand<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ?"</span>)</span>
<span id="annotated-cell-29-32">                placeholder_values.append(placeholder_value)</span>
<span id="annotated-cell-29-33">        where_query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" AND "</span>.join(where_clauses)</span>
<span id="annotated-cell-29-34">                    </span>
<span id="annotated-cell-29-35">    offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (page <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> size</span>
<span id="annotated-cell-29-36">    cursor.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT COUNT(id) as count FROM alarms"</span>)</span>
<span id="annotated-cell-29-37">    n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchone()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>]</span>
<span id="annotated-cell-29-38">    n_pages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> size <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="annotated-cell-29-39">    </span>
<span id="annotated-cell-29-40">    cursor.execute(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"SELECT * FROM alarms </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>where_query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> LIMIT ? OFFSET ?"</span>, (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>placeholder_values, size, offset))</span>
<span id="annotated-cell-29-41">    alarms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchall()</span>
<span id="annotated-cell-29-42">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {</span>
<span id="annotated-cell-29-43">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'last_page'</span>: n_pages,</span>
<span id="annotated-cell-29-44">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data'</span>: alarms </span>
<span id="annotated-cell-29-45">    }</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div>
</div>
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-29" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="11,12,13" data-code-annotation="1">I’m converting the list of filters as a list of SQL expressions that will end inside a <code>WHERE</code> clause.</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="19" data-code-annotation="2">In this case I’m using an sqlite function to check if the <code>field</code> in the filter object passed is actually an existing column. In other databases and libraries such as PostgreSQL and pyscopg you can safely escape SQL identifier. In this case you can’t so either you <a href="https://stackoverflow.com/a/6701665/7635240">escape the column name by your own</a> or (at least I think) you check that the column name is valid and existing.</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="23" data-code-annotation="3">The safety on the user input applies also for the operand, called <code>type</code> in the filter payload. In this case I’m supporting only two operators: <code>LIKE</code> and <code>=</code>. Any other string would raise an HTTP response with status code 400</span>
</dd>
</dl>
<p>And that’s it, now we have text filtering!</p>
</section>
<section id="adding-date-filters" class="level2">
<h2 class="anchored" data-anchor-id="adding-date-filters">Adding date filters</h2>
<p>Now that the general idea behind server side filtering is clear, we could extend the filtering also to dates.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/templates/index.html</strong></pre>
</div>
<div class="sourceCode" id="cb27" data-source-line-numbers="23-25,43,44" data-code-line-numbers="23-25,43,44" style="background: #f1f3f5;"><pre class="sourceCode numberSource html number-lines code-with-copy"><code class="sourceCode html"><span id="cb27-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;!DOCTYPE </span>html<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb27-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;html&gt;</span></span>
<span id="cb27-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;head&gt;</span></span>
<span id="cb27-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;title&gt;</span>Alarms<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/title&gt;</span></span>
<span id="cb27-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;style&gt;</span></span>
<span id="cb27-6">        body {</span>
<span id="cb27-7">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">font-family</span>: Arial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">sans-serif</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-8">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-9">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-10">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">background-color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#f0f0f0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-11">        }</span>
<span id="cb27-12">        h1 {</span>
<span id="cb27-13">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#333</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-14">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">text-align</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">center</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-15">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">px</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-16">        }</span>
<span id="cb27-17">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#alarms-table</span> {</span>
<span id="cb27-18">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">rem</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb27-19">        }</span>
<span id="cb27-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/style&gt;</span></span>
<span id="cb27-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;link</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">href</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">rel</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stylesheet"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb27-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;script</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text/javascript"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">src</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/script&gt;</span></span>
<span id="cb27-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;script</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">src</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.3/luxon.min.js"</span></span>
<span id="cb27-24"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">        integrity=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sha512-gUQcFuEaDuAEqvxIQ9GDdMcCeFmG5MPnoc6ruJn+nyCNHrHM2oB97GOVLIOiixzTxPYmIfEQbOoQmx55UscLyw=="</span></span>
<span id="cb27-25"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">        crossorigin=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"anonymous"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">referrerpolicy</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no-referrer"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/script&gt;</span></span>
<span id="cb27-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/head&gt;</span></span>
<span id="cb27-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;body&gt;</span></span>
<span id="cb27-28">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;h1&gt;</span>Alarms list<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/h1&gt;</span></span>
<span id="cb27-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;div</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">id</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alarms-table"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/div&gt;</span></span>
<span id="cb27-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;script&gt;</span></span>
<span id="cb27-31">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tabulator</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#alarms-table"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb27-32">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">layout</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fitDataStretch'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-33">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxURL</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarms"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-34">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxContentType</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'json'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-35">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxConfig</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'POST'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-36">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">pagination</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-37">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">paginationMode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remote"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-38">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">paginationSize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-39">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">filterMode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'remote'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-40">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">autoColumns</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-41">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">autoColumnsDefinitions</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> [</span>
<span id="cb27-42">                {<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">field</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Text'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">headerFilter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb27-43">                {<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">field</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'timestamp'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Alarm timestamp'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb27-44">                 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">formatter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'datetime'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">headerFilter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>}</span>
<span id="cb27-45">            ]</span>
<span id="cb27-46">        })</span>
<span id="cb27-47">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/script&gt;</span></span>
<span id="cb27-48"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/body&gt;</span></span>
<span id="cb27-49"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/html&gt;</span></span></code></pre></div>
</div>
<p>Note that I have added the luxon.js library <a href="https://tabulator.info/docs/5.5/format#formatter-link">as mentioned in the tabulator documentation</a>. I have a put a date filter for a datetime column. This is because I would like the filter to get only the rows received on a particular date.</p>
<p>On the backend side we would need to deal with this particular case: if the column is <code>timestamp</code>, then we can convert the timestamp to date and use it for our <code>where</code> clause:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="cb28" data-code-line-numbers="25,26,27,28,29,30,31,32,33,34,35" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1">...</span>
<span id="cb28-2"></span>
<span id="cb28-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@app.post</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarms"</span>)</span>
<span id="cb28-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> home(</span>
<span id="cb28-5">    request: Request,</span>
<span id="cb28-6">    page: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, Body(ge<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb28-7">    size: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, Body(lt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,</span>
<span id="cb28-8">    db: sqlite3.Connection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Depends(get_db), </span>
<span id="cb28-9">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>], Body()] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb28-10">):</span>
<span id="cb28-11">    db.row_factory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.Row</span>
<span id="cb28-12">    cursor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.cursor()</span>
<span id="cb28-13">    where_clauses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-14">    where_query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb28-15">    placeholder_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb28-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>):  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply a WHERE clause in the SQL query</span></span>
<span id="cb28-17">        where_query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" WHERE "</span></span>
<span id="cb28-18">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> filter_obj <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">filter</span>:</span>
<span id="cb28-19">            field, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>, value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> filter_obj[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'field'</span>], filter_obj[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'type'</span>], filter_obj[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'value'</span>]</span>
<span id="cb28-20">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check that the filter field can be trusted and exists as a column in our table</span></span>
<span id="cb28-21">            cursor.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"select name from PRAGMA_TABLE_INFO('alarms') where name = ?"</span>, (field,))</span>
<span id="cb28-22">            column_field <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchone()</span>
<span id="cb28-23">            operand <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>.upper()</span>
<span id="cb28-24">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> column_field:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the filter field exists as a column</span></span>
<span id="cb28-25">                identifier <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> column_field[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>] </span>
<span id="cb28-26">                match (operand, identifier): </span>
<span id="cb28-27">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">case</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LIKE'</span>, _: <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if using like as tabulator mention, add wildcards </span></span>
<span id="cb28-28">                        placeholder_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'%</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">%'</span> </span>
<span id="cb28-29">                    case (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'='</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'timestamp'</span>): </span>
<span id="cb28-30">                        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert the timestamp identifier column to a date </span></span>
<span id="cb28-31">                        column_field </span>
<span id="cb28-32">                        placeholder_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value </span>
<span id="cb28-33">                        identifier <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"strftime('%Y-%m-%d', </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>column_field[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'name'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span> </span>
<span id="cb28-34">                    case (<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'='</span>, _):  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># this is mostly used for numerical, categorical or date filtering </span></span>
<span id="cb28-35">                        placeholder_value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> value </span>
<span id="cb28-36"></span>
<span id="cb28-37">                    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">case</span> other:  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the operand is not supported, return an HTTP 400 response</span></span>
<span id="cb28-38">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> HTTPException(status_code<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>, detail<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Filter type </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>operand<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> not supported."</span>)</span>
<span id="cb28-39">    </span>
<span id="cb28-40">                where_clauses.append(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>identifier<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>operand<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> ?"</span>)</span>
<span id="cb28-41">                placeholder_values.append(placeholder_value)</span>
<span id="cb28-42">        where_query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" AND "</span>.join(where_clauses)</span>
<span id="cb28-43">                    </span>
<span id="cb28-44">    offset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (page <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> size</span>
<span id="cb28-45">    cursor.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT COUNT(id) as count FROM alarms"</span>)</span>
<span id="cb28-46">    n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchone()[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>]</span>
<span id="cb28-47">    n_pages <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> size <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> n_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb28-48">    </span>
<span id="cb28-49">    cursor.execute(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"SELECT * FROM alarms </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>where_query<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> LIMIT ? OFFSET ?"</span>, (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>placeholder_values, size, offset))</span>
<span id="cb28-50">    alarms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchall()</span>
<span id="cb28-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {</span>
<span id="cb28-52">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'last_page'</span>: n_pages,</span>
<span id="cb28-53">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data'</span>: alarms </span>
<span id="cb28-54">    }</span></code></pre></div>
</div>
<p>As you can see I made use of python’s <code>match</code> operator to match on both the <code>field</code> and the <code>type</code>. In the case of <code>alarm</code> as a field I am casting the datetime column to date.</p>
<p>After setting all this up you should have a nice table that allows you to filter on the text and date column.</p>
<p>This is the end result I’m getting for the code written:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/tabulator-sql-fastapi/tabulator_example.gif" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Tabulator example</figcaption>
</figure>
</div>
</section>
</section>
<section id="showing-a-single-alarm" class="level1">
<h1>Showing a single alarm</h1>
<p>When a table contains a lot of columns or a lot of text, it might be useful to inspect a single alarm. One way this could be done is to add a link to each row of the table that brings to an <code>alarm.html</code> page with the details of the alarm inspected. To do so, we can use the <code>id</code> column of the table and format it to render an url:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/templates/index.html</strong></pre>
</div>
<div class="sourceCode" id="cb29" data-source-line-numbers="45-61" data-code-line-numbers="45-61" style="background: #f1f3f5;"><pre class="sourceCode numberSource html number-lines code-with-copy"><code class="sourceCode html"><span id="cb29-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;!DOCTYPE </span>html<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb29-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;html&gt;</span></span>
<span id="cb29-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;head&gt;</span></span>
<span id="cb29-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;title&gt;</span>Alarms<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/title&gt;</span></span>
<span id="cb29-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;style&gt;</span></span>
<span id="cb29-6">        body {</span>
<span id="cb29-7">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">font-family</span>: Arial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">sans-serif</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-8">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-9">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-10">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">background-color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#f0f0f0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-11">        }</span>
<span id="cb29-12">        h1 {</span>
<span id="cb29-13">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#333</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-14">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">text-align</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">center</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-15">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">px</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-16">        }</span>
<span id="cb29-17">        <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">#alarms-table</span> {</span>
<span id="cb29-18">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">rem</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-19">        }</span>
<span id="cb29-20">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/style&gt;</span></span>
<span id="cb29-21">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;link</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">href</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">rel</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stylesheet"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb29-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;script</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;"> type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text/javascript"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">src</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/script&gt;</span></span>
<span id="cb29-23">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;script</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">src</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.3/luxon.min.js"</span></span>
<span id="cb29-24"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">        integrity=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sha512-gUQcFuEaDuAEqvxIQ9GDdMcCeFmG5MPnoc6ruJn+nyCNHrHM2oB97GOVLIOiixzTxPYmIfEQbOoQmx55UscLyw=="</span></span>
<span id="cb29-25"><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">        crossorigin=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"anonymous"</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">referrerpolicy</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"no-referrer"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/script&gt;</span></span>
<span id="cb29-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/head&gt;</span></span>
<span id="cb29-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;body&gt;</span></span>
<span id="cb29-28">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;h1&gt;</span>Alarms list<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/h1&gt;</span></span>
<span id="cb29-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;div</span> <span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">id</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"alarms-table"</span><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&gt;&lt;/div&gt;</span></span>
<span id="cb29-30">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;script&gt;</span></span>
<span id="cb29-31">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">var</span> table <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">new</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tabulator</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#alarms-table"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> {</span>
<span id="cb29-32">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">layout</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fitDataStretch'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-33">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxURL</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarms"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-34">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxContentType</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'json'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-35">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">ajaxConfig</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'POST'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-36">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">pagination</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-37">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">paginationMode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remote"</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-38">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">paginationSize</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-39">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">filterMode</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'remote'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-40">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">autoColumns</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">true</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-41">            <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">autoColumnsDefinitions</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> [</span>
<span id="cb29-42">                {<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">field</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Text'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">headerFilter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-43">                {<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">field</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'timestamp'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Alarm timestamp'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> </span>
<span id="cb29-44">                 <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">formatter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'datetime'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">headerFilter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'date'</span>}<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-45">                {</span>
<span id="cb29-46">                    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">field</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-47">                    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">title</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Link'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-48">                    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">formatter</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span> (cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> formatterParams<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> onRendered) {</span>
<span id="cb29-49">                        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> value <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cell<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getValue</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-50">                        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">let</span> href <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>formatterParams[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"urlPrefix"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}${</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb29-51">                        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">`&lt;a href=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">${</span>href<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb29-52"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">                            &lt;svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="height: 1rem;"&gt;</span></span>
<span id="cb29-53"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">                                &lt;path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" /&gt;</span></span>
<span id="cb29-54"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">                            &lt;/svg&gt;</span></span>
<span id="cb29-55"><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">                        &lt;/a&gt;`</span></span>
<span id="cb29-56">                    }<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-57">                    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">formatterParams</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> {</span>
<span id="cb29-58">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">urlPrefix</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/alarm?id='</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span></span>
<span id="cb29-59">                        <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">target</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'_blank'</span></span>
<span id="cb29-60">                    }</span>
<span id="cb29-61">                }</span>
<span id="cb29-62">            ]</span>
<span id="cb29-63">        })</span>
<span id="cb29-64">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/script&gt;</span></span>
<span id="cb29-65"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/body&gt;</span></span>
<span id="cb29-66"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/html&gt;</span></span></code></pre></div>
</div>
<p>We can pass a function to the <code>formatter</code> argument of each field. In this case I am getting the <code>id</code> and returning an <code>&lt;a&gt;</code> tag with an <code>href</code> to the link we would like to open and inside a nice svg icon.</p>
<p>We can then create a new jinja html page in the <code>app/templates</code> folder</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/templates/alarm.html</strong></pre>
</div>
<div class="sourceCode" id="cb30" data-code-line-numbers="" style="background: #f1f3f5;"><pre class="sourceCode numberSource html number-lines code-with-copy"><code class="sourceCode html"><span id="cb30-1"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&lt;!DOCTYPE </span>html<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">&gt;</span></span>
<span id="cb30-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;html&gt;</span></span>
<span id="cb30-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;head&gt;</span></span>
<span id="cb30-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;title&gt;</span>Alarms<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/title&gt;</span></span>
<span id="cb30-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;style&gt;</span></span>
<span id="cb30-6">        body {</span>
<span id="cb30-7">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">font-family</span>: Arial<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">,</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">sans-serif</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-8">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-9">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-10">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">background-color</span>: <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">#f0f0f0</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-11">        }</span>
<span id="cb30-12">        dl {</span>
<span id="cb30-13">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">margin</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">rem</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-14">        }</span>
<span id="cb30-15">        dt {</span>
<span id="cb30-16">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">font-weight</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">bold</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-17">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">rem</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-18">        }</span>
<span id="cb30-19">        dd {</span>
<span id="cb30-20">            <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">padding</span>: <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">rem</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb30-21">        }</span>
<span id="cb30-22">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/style&gt;</span></span>
<span id="cb30-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/head&gt;</span></span>
<span id="cb30-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;body&gt;</span></span>
<span id="cb30-25">    {% if alarm %}</span>
<span id="cb30-26">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;dl&gt;</span></span>
<span id="cb30-27">    {% for column_name in alarm.keys() %}</span>
<span id="cb30-28">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;dt&gt;</span>{{ column_name | capitalize }}<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/dt&gt;</span></span>
<span id="cb30-29">        <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;dd&gt;</span>{{ alarm[column_name] }}<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/dd&gt;</span></span>
<span id="cb30-30">    {% endfor %}</span>
<span id="cb30-31">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/dl&gt;</span></span>
<span id="cb30-32">    {% endif %}</span>
<span id="cb30-33"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/body&gt;</span></span>
<span id="cb30-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;/html&gt;</span></span></code></pre></div>
</div>
<p>The page will display the <code>alarm</code> object passed to the template, which will be an <code>sqlite.Row</code> object, which maps column names to values. In the <code>app/main.py</code> we can modify the <code>alarm()</code> function to serve a jinja template</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>app/main.py</strong></pre>
</div>
<div class="sourceCode" id="cb31" data-code-line-numbers="13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1">...</span>
<span id="cb31-2"></span>
<span id="cb31-3"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@app.get</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/alarm"</span>)</span>
<span id="cb31-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">async</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> alarm(</span>
<span id="cb31-5">    request: Request,</span>
<span id="cb31-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>: Annotated[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, Query()],</span>
<span id="cb31-7">    db: sqlite3.Connection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Depends(get_db),</span>
<span id="cb31-8">):</span>
<span id="cb31-9">    db.row_factory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sqlite3.Row</span>
<span id="cb31-10">    cursor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> db.cursor()</span>
<span id="cb31-11">    cursor.execute(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"SELECT * FROM alarms WHERE id = ?"</span>, (<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">id</span>, ))</span>
<span id="cb31-12">    alarm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cursor.fetchone()</span>
<span id="cb31-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> templates.TemplateResponse(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alarm.html'</span>, context<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'request'</span>: request, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'alarm'</span>: alarm}) </span>
<span id="cb31-14">    </span>
<span id="cb31-15">...</span></code></pre></div>
</div>
<p>The final result should look like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/tabulator-sql-fastapi/tabulator_example.gif" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Tabulator example</figcaption>
</figure>
</div>
</section>
<section id="conclusion-and-remarks" class="level1">
<h1>Conclusion and remarks</h1>
<p>The idea of this blog post was for me to document the steps required to create a powerful javascript table that wraps a data source. In my real case I am using a different database and different visualization features, but the main ideas are the one shown here. In case you would like to clone the final result you can check out my github repo here: <a href="https://github.com/grigolet/tabulator-sql-fastapi-demo">https://github.com/grigolet/tabulator-sql-fastapi-demo</a>. There are for sure better ways to implement what I’ve done and any suggestion is more than welcome. I may also have some unsafe code. If that is the case, please feel free to let me know in the comments. There are other features that I haven’t investigated yet, such as having categorical selections on some columns. I might update this post if further developments happen.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>web</category>
  <category>fastapi</category>
  <category>tabulator</category>
  <category>SQL</category>
  <guid>https://grigolet.github.io/posts/tabulator-sql-fastapi/index.html</guid>
  <pubDate>Fri, 22 Sep 2023 22:00:00 GMT</pubDate>
  <media:content url="https://grigolet.github.io/posts/tabulator-sql-fastapi/preview.png" medium="image" type="image/png" height="68" width="144"/>
</item>
<item>
  <title>My take on overlapping densities (a.k.a. ridge) plots</title>
  <link>https://grigolet.github.io/posts/overlapping-densities-plots/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Recently I had to produce some plots showing a distribution of the charge that is induced by an ionizing particle passing through a gasesous detector. Such distribution is highly dependent on the electric field in the gas medium and the gas mixture itself. Since I am studying eco-friendly gas mixture for a particular kind of the detector I wanted to compare the charge distribution that the detectors have when operated with different gas mixture. In this context, I initially though about overlapping the charge distributions, but there may be some features about the distribution that can easily get lost when plotting one histogram on top of the other.</p>
<p>In addition, I wanted to produce some histograms with a style consistent to the other plots that I usually make, so I am using my custom matplotlib stylesheet, as explained in my <a href="../../posts/my-matplotlib-stylesheet/index.html">previous blog post</a></p>
<p>In order to show the issue that I had to fight with, I have prepared a <code>.csv</code> file containing two columns: one colum represents the charge that will be plotted in the form of a histogram. The second column is categorical label indicating to which gas mixture the measured charge belongs to.</p>
<p>Also, I often use <a href="https://seaborn.pydata.org/">seaborn</a> to help me produce these kind of plots.</p>
<p>Let me start by showing the different charge distributions:</p>
<div class="cell" data-execution_count="60">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mpl</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-6"></span>
<span id="cb1-7">plt.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://gitlab.cern.ch/-/snippets/2223/raw/master/rpcecogas.mplstyle'</span>)</span>
<span id="cb1-8">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'charge_distribution.csv'</span>, index_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-9"></span>
<span id="cb1-10">df.head()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="60">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">charge</th>
<th data-quarto-table-cell-role="th">label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2.521321</td>
<td>Standard</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2.074056</td>
<td>Standard</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.207791</td>
<td>Standard</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.663411</td>
<td>Standard</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.618327</td>
<td>Standard</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>If I try to plot a histogram of <code>charge</code> with a color based on the <code>label</code> category I get this:</p>
<div class="cell" data-fig-label="fig-default-histogram" data-execution_count="61">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.histplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'charge'</span>, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>, log_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, </span>
<span id="cb2-2">             stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'density'</span>, common_norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'step'</span>,</span>
<span id="cb2-3">             bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>), fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb2-4">ax.get_legend().set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Label'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/overlapping-densities-plots/index_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Charge distribution of different gas mixtures</figcaption>
</figure>
</div>
</div>
</div>
<p>The above plot was made using the seaborn <code>histplot()</code> function, using a logarithmic scale on the x axis. In this particular case one can see that the blue distribution has a nice, single, bell shape, while the other three distributions, which represent gas mixtures with the addition of CO<img src="https://latex.codecogs.com/png.latex?_2"> to the standard gas mixture, have a more complex behaviour. Although it looks clear that with an increase of CO<img src="https://latex.codecogs.com/png.latex?_2"> the region with a charge higher than 20 a.u. is increasing, the behaviour on lower region is difficult to understand due to the overlapping lines, especially in the region around 2 a.u.</p>
<p>The idea was then to try to make a ridge plot, where the the histograms are shifted of a fixed offest along the y-axis. In this case, my starting point was a plot made with seaborn, although there are <a href="https://matplotlib.org/matplotblog/posts/create-ridgeplots-in-matplotlib/">plain matplotlib solutions</a>. The <a href="https://seaborn.pydata.org/examples/kde_ridgeplot">seaborn documentation</a> on ridge plots suggests to use a <code>FacetGrid</code> object and make use of the method <code>FacetGrid.map</code> to use a seaborn drawing functions on top of the figure created by the <code>FacetGrid</code>. The <code>FacetGrid</code> object pass a <code>row</code> parameter which should contains the name of a column of the dataframe being used. The <code>row</code> parameter allows to create unique rows of plots depending on how many unique values the dataframe column has.</p>
<p>In addition, I also want the lines to be colored differently depending on the label, so I will also make use of the <code>hue</code> parameter.</p>
<p>By only using map I get this results:</p>
<div class="cell" data-fig-label="fig-matplotlib-initial-ridgeplot" data-fig-caption="Using `FacetGrid` as a starting point for a ridge plot." data-execution_count="62">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.FacetGrid(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>, row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>, aspect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the seaborn histplot() function to create histograms</span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for each row. In this case I am passing the same</span></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># arguments of the plot made before</span></span>
<span id="cb3-5">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(sns.histplot, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'charge'</span>, log_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, </span>
<span id="cb3-6">             stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'density'</span>, common_norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'step'</span>,</span>
<span id="cb3-7">             bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>), fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/overlapping-densities-plots/index_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>This plot can be considered as an improvement with respect to <strong>?@fig-default-histogram</strong> as it allows to clearly see the shape difference between the charge distributions. It is indeed possible to observe a a less sharp charge distribution in the last histogram (the red one) if compared to the previous one (the green house).</p>
<p>The only downside of such a plot is its vertical space. There are axes frames, axes titles and ticks that eat up a significant amount of space. So in this case I would get rid of the top, bottom and left axes frames and titles, except for the last one:</p>
<div class="cell" data-fig-label="fig-matplotlib-improved-ridgeplot" data-fig-caption="Removing axes frames" data-execution_count="85">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.FacetGrid(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>, row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>, aspect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the seaborn histplot() function to create histograms</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for each row. In this case I am passing the same</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># arguments of the plot made before</span></span>
<span id="cb4-5">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(sns.histplot, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'charge'</span>, log_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, </span>
<span id="cb4-6">             stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'density'</span>, common_norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'step'</span>,</span>
<span id="cb4-7">             bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>), fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove all left, top and right frames</span></span>
<span id="cb4-9">g.despine(left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, top<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, bottom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/overlapping-densities-plots/index_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Now I would like to remove the ticks on the sides, bottom and top as I did for the frames. To do this, I would set the ticks length to 0 and the tick labels to an empty list:</p>
<div class="cell" data-fig-label="fig-matplotlib-improved-ridgeplot-no-ticks" data-fig-caption="Removing ticks" data-execution_count="92">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adding a matplotlib rc_context to disable ticks</span></span>
<span id="cb5-2">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.FacetGrid(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>, row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>, aspect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb5-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the seaborn histplot() function to create histograms</span></span>
<span id="cb5-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for each row. In this case I am passing the same</span></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># arguments of the plot made before</span></span>
<span id="cb5-6">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(sns.histplot, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'charge'</span>, log_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, </span>
<span id="cb5-7">            stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'density'</span>, common_norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'step'</span>,</span>
<span id="cb5-8">            bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>), fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove all left, top and right frames</span></span>
<span id="cb5-10">g.despine(left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, top<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, bottom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Manually removing ticks</span></span>
<span id="cb5-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> g.axes.ravel()[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]:</span>
<span id="cb5-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove ticks by settings their length to 0</span></span>
<span id="cb5-14">    ax.tick_params(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'both'</span>, length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, which<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'both'</span>)</span>
<span id="cb5-15"></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use seaborn to remove y labels and titles</span></span>
<span id="cb5-17">g.set_axis_labels(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Charge [pC]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb5-18">g.set_titles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb5-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove y ticks from all axes</span></span>
<span id="cb5-20">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(yticklabels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[])</span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove the spines also on the last plot, except for the bottom one</span></span>
<span id="cb5-22">last_ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.axes.flat[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb5-23">sns.despine(left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, top<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, bottom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>g.axes.flat[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb5-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use mpl apis to remove ticks</span></span>
<span id="cb5-25">last_ax.tick_params(top<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, which<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'both'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/overlapping-densities-plots/index_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Now, what is left is to get the distributions closer to each other and eventually add a label to each of them, indicating to which category they belong:</p>
<div class="cell" data-fig-label="fig-matplotlib-improved-ridgeplot-final" data-fig-caption="Final ridge plot" data-execution_count="93">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add_label(x, color, label):</span>
<span id="cb6-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Add a label to each mapped category"""</span></span>
<span id="cb6-3">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.gca()</span>
<span id="cb6-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The position of the label depends on the figure size and layout.</span></span>
<span id="cb6-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For this reason, the x and y coordinates may need to be set manually.</span></span>
<span id="cb6-6">    ax.text(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>, label, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>color, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>, fontweight<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>,</span>
<span id="cb6-7">            ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"right"</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, transform<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax.transAxes)</span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Minor adjustment on aspect and height: use a large aspect for broad</span></span>
<span id="cb6-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># distributions and set height to 1 (this value depends also on the</span></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># matplotlib's dpi resolution)</span></span>
<span id="cb6-12">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.FacetGrid(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>, row<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>, aspect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-13"></span>
<span id="cb6-14">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(sns.histplot, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'charge'</span>, log_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, </span>
<span id="cb6-15">            stat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'density'</span>, common_norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, element<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'step'</span>,</span>
<span id="cb6-16">            bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>), fill<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb6-17"></span>
<span id="cb6-18">g.despine(left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, top<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, bottom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb6-19"></span>
<span id="cb6-20"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> g.axes.ravel()[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]:</span>
<span id="cb6-21">    ax.tick_params(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'both'</span>, length<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, which<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'both'</span>)</span>
<span id="cb6-22">    </span>
<span id="cb6-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Map the label function to each 'hue' catgory of seaborn</span></span>
<span id="cb6-24">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(add_label, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"label"</span>)</span>
<span id="cb6-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the subplots get close together by decreasing the horizontal space</span></span>
<span id="cb6-26">g.fig.subplots_adjust(hspace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>)</span>
<span id="cb6-27"></span>
<span id="cb6-28">g.set_titles(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb6-29">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(yticklabels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[])</span>
<span id="cb6-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For some seaborn internal reason, the set_titles() function</span></span>
<span id="cb6-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># should be called after the map function, otherwise the titles</span></span>
<span id="cb6-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># won't be removed</span></span>
<span id="cb6-33">g.set_axis_labels(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Charge [pC]"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span>
<span id="cb6-34">last_ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.axes.flat[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb6-35">sns.despine(left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, top<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, bottom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>last_ax)</span>
<span id="cb6-36">last_ax.tick_params(top<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, left<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, right<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, which<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'both'</span>)</span>
<span id="cb6-37"></span>
<span id="cb6-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set a transparent facecolor, otherwise the white backround of a </span></span>
<span id="cb6-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># subplot will cover the ones behind</span></span>
<span id="cb6-40">g.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(facecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb6-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make the sublots closer by removing some horizontal space between</span></span>
<span id="cb6-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># them</span></span>
<span id="cb6-43">g.fig.subplots_adjust(hspace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/overlapping-densities-plots/index_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Et voilà, the plot is ready. What should be mentioned is that in this case I have combined both seaborn and matplotlib’s API’s, although I’m pretty sure there is a cleaner way with matplotlib APIs only. For the code, there are few caveats that should be taken into account:</p>
<ul>
<li>The addition of a label is done by setting the coordinates relative to the subplots with hand-crafted values. I haven’t found yet a better solution;</li>
<li>The addition of a label using seaborn’s <code>FacetGrid.map()</code> function should be done before setting titls and axes labels using seaborn <code>FacetGrid.set()</code>. I haven’t digged down to see why to be honest, but if one first sets the titles to <code>""</code> and later uses the <code>map()</code> function the titles are coming back.</li>
<li>The subplots should have a transparent face color. My default stylesheet has a white facecolor. If I don’t change the facecolor, the subplots on the front will partially cover the ones in the back.</li>
</ul>
<p>Also, one can notice that this kind of plot is providing some easier way to compare different distributions when they have different skeweness and shapes.</p>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>In this post I showed how I am using seaborn and matplotlib to create my own, publication-ready, ridge plot, which is at the end a simple overlapping of histograms with some additional styles applied. To sum up, the steps that I have applied to get this plot:</p>
<ol type="1">
<li>Despine everything if using seaborn</li>
<li>Set the xtick length to 0 for all the axes except the last one</li>
<li>Set all axes titles to “” and all <code>yticklabels</code> to an empty list</li>
<li>Re apply despine to leave the bottom spines for the last axis</li>
<li>Put back the bottom spine on the last axis using again <code>sns.despine()</code></li>
<li>Remove ticks from top, left, right faces of the last axis</li>
<li>Set the facecolor of the axes to be transparent</li>
<li>Gets the subplots closer using <code>plt.subplots_adjust()</code> and a negative <code>hspace</code></li>
</ol>
<p>There may be a more straightforward way to do this and in that I case I would be glad to see it, but so far it is the only way I found to get a plot that does what I needed. I found this kind of visualization very interesting and a bit more easy to use in publications with respect to the ridge plots showed in other tutorials and documentations as it doesn’t have any fill color on the distribution, it’s consistent with the applied stylesheet and it is relatively uncluttured.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>matplotlib</category>
  <category>plot</category>
  <category>visualization</category>
  <category>ridge-plot</category>
  <guid>https://grigolet.github.io/posts/overlapping-densities-plots/index.html</guid>
  <pubDate>Sun, 16 Oct 2022 22:00:00 GMT</pubDate>
  <media:content url="https://grigolet.github.io/posts/overlapping-densities-plots/preview.png" medium="image" type="image/png" height="151" width="144"/>
</item>
<item>
  <title>Time Over Threshold in signal processing</title>
  <link>https://grigolet.github.io/posts/time-over-threshold-in-signals/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>A part of my work consists of acquiring the signal induced on a set of copper strips of a gaseous detectors. The signals dynamics such as the height, shape, duration, typically give useful information about what is going on inside the detector. The signal generated by a gasesous detector depends on several factors: - he geometry, layout and working principle of the detector itself; - the electric field applied in the gas medium that allows for the electron created by an ionizing particle to start an avalanche process and move a sufficiently high number of electrons to be detected by the electronics; - the gas used, which greatly affects the dynamic of the avalanche development</p>
<p>Among all of these parameters, I would like to focus on one: the time over threshold. The time over threshold can be defined in different ways. For simplicity, I will define it as the difference of the time between the signal first and last crosses a fixed treshold.</p>
<p>For example, look at the plot Figure&nbsp;1</p>
<div class="cell" data-execution_count="25">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The holy trininty of libraries that will be used</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># throughout the post</span></span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Just to set the maximum of items to be printed for an array</span></span>
<span id="cb1-8">np.set_printoptions(threshold<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># A better style for plots</span></span>
<span id="cb1-11">plt.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://gitlab.cern.ch/-/snippets/2223/raw/master/rpcecogas.mplstyle'</span>)</span></code></pre></div>
</details>
</div>
<div class="cell" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1">window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">520</span></span>
<span id="cb2-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This file contains 10 waveforms of 520 samples. Each sample is written on a single line</span></span>
<span id="cb2-3">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://gist.githubusercontent.com/grigolet/09ffada96abb2acf0fe34070f0e83211/raw/3880aa89e4b113ea2866ec8e3768c03e98f84118/signals.txt"</span>,</span>
<span id="cb2-4">                header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'waveform'</span>])</span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in the next line I will transform the dataframe into a 2d</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># numpy array with shape (number of signals, window length).</span></span>
<span id="cb2-7">waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.waveform.values.reshape((<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, window_length))</span>
<span id="cb2-8"></span>
<span id="cb2-9">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb2-10">ax.plot(waveforms.T)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb2-11">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time [2 ns]'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ADC [a.u.]'</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Waveforms'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="fig-waveforms" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/index_files/figure-html/fig-waveforms-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Waveform read-out from a gaseous detector</figcaption>
</figure>
</div>
</div>
</div>
<p>Image that we would like to compute the duration of all the signals below a threshold that I arbitrarly fix. For example:</p>
<div class="cell" data-execution_count="201">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare and read the data</span></span>
<span id="cb3-2">window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">520</span></span>
<span id="cb3-3">threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8235</span></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This file contains 10 waveforms of 520 samples. Each sample is written on a single line</span></span>
<span id="cb3-5">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://gist.githubusercontent.com/grigolet/09ffada96abb2acf0fe34070f0e83211/raw/3880aa89e4b113ea2866ec8e3768c03e98f84118/signals.txt"</span>,</span>
<span id="cb3-6">                header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'waveform'</span>])</span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in the next line I will transform the dataframe into a 2d</span></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># numpy array with shape (number of signals, window length).</span></span>
<span id="cb3-9">waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.waveform.values.reshape((<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, window_length))</span>
<span id="cb3-10"></span>
<span id="cb3-11">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb3-12"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ix, waveform <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(waveforms):</span>
<span id="cb3-13">    ax.plot(waveform, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Waveform </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb3-14">ax.axhline(threshold, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb3-15">ax.legend(loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper left'</span>, bbox_to_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb3-16">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time [2 ns]'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ADC [a.u.]'</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Waveforms. Threshold at </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>threshold<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/index_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="tot-by-taking-the-closest-samples" class="level1">
<h1>ToT by taking the closest samples</h1>
<section id="the-1d-case" class="level2">
<h2 class="anchored" data-anchor-id="the-1d-case">The 1d case</h2>
<p>In this case, the easiest and probably more natual approach to compute the ToT would be to get the first sample below the threshold, the last sample below the threshold and do a difference.</p>
<p>This is fairly straightforward in the case of a single signal and it can be accomplished in few different ways:</p>
<div class="cell" data-execution_count="40">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># From the previous cell we have waveforms available in a 2d</span></span>
<span id="cb4-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># numpy array of shape (n waveforms, n samples)</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I will take waveform 8 just for example purposes</span></span>
<span id="cb4-4"></span>
<span id="cb4-5">threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8235</span></span>
<span id="cb4-6">waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, :]</span>
<span id="cb4-7">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb4-8">ax.plot(waveform)</span>
<span id="cb4-9">ax.axhline(threshold, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>&lt;matplotlib.lines.Line2D at 0x7fb662c0cd90&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/index_files/figure-html/cell-5-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>For the way I defined the time over threshold, I would have to take the first sample before crossing the threshold and the last one before going back</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1">samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold</span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Boolean array indicating which sample is below the threshold</span></span>
<span id="cb6-3">samples_below_threshold</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>array([False, False, False, ..., False, False, False])</code></pre>
</div>
</div>
<p>If I imagine the boolean array defined above as an integer array, I could use <code>np.argmax()</code> to find the first item for which the condition is true, i.e.&nbsp;the first item crossing the threshold.</p>
<p>To find instead the last item I could use <code>np.argmax()</code> but applied to the reversed array, taking into account that the resulting index should be then subtracted with the number of samples of the waveform</p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1">first_item <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold)</span>
<span id="cb8-2">last_item <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-3">first_item, last_item</span>
<span id="cb8-4"></span>
<span id="cb8-5">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb8-6">ax.plot(waveform)</span>
<span id="cb8-7">ax.axhline(threshold, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb8-8">ax.axvline(first_item, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>)</span>
<span id="cb8-9">ax.axvline(last_item, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>&lt;matplotlib.lines.Line2D at 0x7fb662bb13f0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/index_files/figure-html/cell-7-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="the-2d-case" class="level2">
<h2 class="anchored" data-anchor-id="the-2d-case">The 2d case</h2>
<p>In a case of a 2d array like <code>waveforms</code>, some numpy gym can be used to perform vectorized operation and avoid using <code>for</code> loops.</p>
<p>A trick I often used to remember on which axis I want to perform an operation on a <code>numpy.ndarray</code>: if the numpy array has a shape (x_dim, y_dim, z_dim, …) then the operation I perform the aggregation on is making that axis collapse.</p>
<p>So in the present case, if I have an <code>(n_waveforms, n_samples)</code> array, then I would expect to have the <code>argmax()</code> of each waveform, so an array with a shape <code>(n_waveforms)</code>. This means that <code>axis=0</code> should be preversed and <code>axis=1</code> should collapse, so the <code>np.argmax()</code> operation should have <code>axis=1</code>.</p>
<p>It’s a bit tricky but it’s working fine in my mental model</p>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold</span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Now we have a 2d array of waveforms but</span></span>
<span id="cb10-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># an analogue boolean mask</span></span>
<span id="cb10-4">samples_below_threshold</span>
<span id="cb10-5"></span>
<span id="cb10-6">first_items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reverse the array over the samples dimensions to get the last </span></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># point of threshold crossing</span></span>
<span id="cb10-9">last_items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[:, ::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb10-10"></span>
<span id="cb10-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(first_items, last_items)</span>
<span id="cb10-12"></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Let's graphically check the results</span></span>
<span id="cb10-14">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb10-15"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ix, waveform <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(waveforms):</span>
<span id="cb10-16">    ax.plot(waveform, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Waveform </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-17">    ax.plot(first_items[ix], threshold, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.'</span>)</span>
<span id="cb10-18">    ax.plot(last_items[ix], threshold, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.'</span>)</span>
<span id="cb10-19">ax.legend(loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper left'</span>, bbox_to_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb10-20">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time [2 ns]'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ADC [a.u.]'</span>, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Waveforms. Threshold at </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>threshold<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[227   0 232 ... 236 249   0] [230 519 237 ... 240 346 519]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/index_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>In the example above I marked the points at which the threshold is crossed. However, in the case of a waveform not crossing the threshold, the <code>np.argmax()</code> function would return 0, so <code>first_item</code> would be equal to 0 and <code>last_item</code> would be equal to <code>window_length - 1</code>, as it is for the 9th waveform:</p>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1">n_waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span></span>
<span id="cb12-2">waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms[n_waveform, :]</span>
<span id="cb12-3">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb12-4"></span>
<span id="cb12-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(first_items[n_waveform], last_items[n_waveform])</span>
<span id="cb12-6">ax.plot(waveform)</span>
<span id="cb12-7">ax.axhline(threshold, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0 519</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>&lt;matplotlib.lines.Line2D at 0x7fb66347db40&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/index_files/figure-html/cell-9-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>So at this step the time over threshold can be simply computed as <code>last_items - first_items</code>, discarding the values equal to <code>window_length - 1</code></p>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1">time_over_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> last_items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> first_items</span>
<span id="cb15-2">time_over_threshold[time_over_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> (window_length  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>array([ 3,  5,  1, 69,  4, 97])</code></pre>
</div>
</div>
</section>
</section>
<section id="a-more-accurate-time-over-threshold-by-linear-interpolation" class="level1">
<h1>A more accurate time over threshold by linear interpolation</h1>
<p>The definition of time over threshold in the cases defined above is working well when the average value of this parameter is significantly sufficienclty high. This would mean that the sampling frequency (or the digitizer resolution) are good enough for this timing measurements.</p>
<p>Some other times, the sampling frequency is not so high and the signals are quite fasts, meaning that their time over threshold is getting smaller and smaller. An idea to improve the time resolution could be to precisely compute the intersection between the threshold viewed as an horizontal line and the segment formed by the sample before and after crossing the threshold.</p>
<p>I will label the coordinates of the points for which the threshold is first crossed with and <code>f</code> for <code>first</code> and the lasts with an <code>l</code> for <code>last</code>. The coordinates that are found before the threshold is passed are labelled with <code>b</code> for <code>before</code> and the ones found just after meeting the threshold are labeled with an <code>a</code> for <code>after</code>. The points we are interested in are the x intersection of the first intersection, that I will call <img src="https://latex.codecogs.com/png.latex?x_f"> and the one of the last that will be called <img src="https://latex.codecogs.com/png.latex?x_l">. The time over threshold would be defined by the difference <img src="https://latex.codecogs.com/png.latex?x_l%20-%20x_f">. I will call the threshold <img src="https://latex.codecogs.com/png.latex?y_t">.</p>
<p>The labeling might be a bit confusing but I will leave here an image to make things clearer:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/graph.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Nomenclature used hereafter.</figcaption>
</figure>
</div>
<section id="the-1d-case-1" class="level2">
<h2 class="anchored" data-anchor-id="the-1d-case-1">The 1d case</h2>
<p>In this case I could set up the code in this way:</p>
<ol type="1">
<li>Find the coordinates before meeting the thresholds, i.e.&nbsp;<img src="https://latex.codecogs.com/png.latex?(x_%7Bfb%7D,%20y_%7Bfb%7D)"> and <img src="https://latex.codecogs.com/png.latex?(x_%7Blb%7D,%20y_%7Blb%7D)"></li>
<li>Find the coordinates after meeting the thresholds, i.e.&nbsp;<img src="https://latex.codecogs.com/png.latex?(x_%7Bfa%7D,%20y_%7Bfa%7D)"> and <img src="https://latex.codecogs.com/png.latex?(x_%7Bla%7D,%20y_%7Bla%7D)"></li>
<li>Find <img src="https://latex.codecogs.com/png.latex?x_f"> using some simple line equation: <img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7Bx_f-%20x_%7Bfb%7D%7D%7By_t%20-%20y_%7Bfb%7D%7D%20=%20%5Cfrac%7Bx_%7Bfa%7D%20-%20x_%7Bfb%7D%7D%7By_%7Bfa%7D%20-%20y_%7Bfb%7D%7D%0A"> <img src="https://latex.codecogs.com/png.latex?%0Ax_f%20=%20x_%7Bfb%7D%20+%20(x_%7Bfa%7D%20-%20x_%7Bfb%7D)%20%5Cleft(%5Cfrac%7By_t%20-%20y_%7Bfb%7D%7D%7By_%7Bfa%7D%20-%20y_%7Bfb%7D%7D%5Cright)%0A"> In a similar way, for <img src="https://latex.codecogs.com/png.latex?x_l">: <img src="https://latex.codecogs.com/png.latex?%0Ax_l%20=%20x_%7Blb%7D%20+%20(x_%7Bla%7D%20-%20x_%7Blb%7D)%20%5Cleft(%5Cfrac%7By_t%20-%20y_%7Bfb%7D%7D%7By_%7Bla%7D%20-%20y_%7Blb%7D%7D%5Cright)%0A"></li>
<li>Calculate the time over threshold as <img src="https://latex.codecogs.com/png.latex?x_l%20-%20x_f"></li>
</ol>
<div class="cell" data-execution_count="287">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># I'm taking the threshold as before as an example</span></span>
<span id="cb17-2">waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, :]</span>
<span id="cb17-3">samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold</span>
<span id="cb17-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the indices xfb and xlb</span></span>
<span id="cb17-5">xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb17-6">xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb17-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The corresponding yfb and ylb are easy to get:</span></span>
<span id="cb17-8">yfb, ylb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveform[xfb], waveform[xlb]</span>
<span id="cb17-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Now we can also find the coordinates of the samples</span></span>
<span id="cb17-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># after meeting the threshold</span></span>
<span id="cb17-11">xfa, yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, waveform[xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb17-12">xla, yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, waveform[xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb17-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find xf and xl</span></span>
<span id="cb17-14">xf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (xfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xfb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb))</span>
<span id="cb17-15">xl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (xla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xlb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb))</span>
<span id="cb17-16">time_over_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xf</span>
<span id="cb17-17"></span>
<span id="cb17-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Let's visualize everything</span></span>
<span id="cb17-19">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb17-20">ax.plot(waveform, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.-'</span>)</span>
<span id="cb17-21">ax.axvline(xfb, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb17-22">ax.axvline(xf, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C2'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb17-23">ax.axvline(xfa, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb17-24"></span>
<span id="cb17-25">ax.axvline(xlb, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb17-26">ax.axvline(xl, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C2'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb17-27">ax.axvline(xla, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb17-28"></span>
<span id="cb17-29">ax.axhline(threshold, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb17-30"></span>
<span id="cb17-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># zoom in in the region of interest</span></span>
<span id="cb17-32">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, xla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Time over threshold = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>time_over_threshold<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="287">
<pre><code>[(243.0, 351.0), Text(0.5, 1.0, 'Time over threshold = 96.4')]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/index_files/figure-html/cell-11-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>As expected, the time over threshold is now computed as the intersection between the horizontal lines and the segments first and last crossing the threshold. The code above is failing in case the threshold is not crossing any segment:</p>
<div class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Waveform 9 is not crossing the threshold</span></span>
<span id="cb19-2">waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, :]</span>
<span id="cb19-3">samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold</span>
<span id="cb19-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># np.argmax returns 0 if nothing is found</span></span>
<span id="cb19-5">xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This would generated some issues because it's 520 - 0 = 520 </span></span>
<span id="cb19-7">xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) </span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This part will throw an error because waveform has only</span></span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 520 samples and waveform[520] is outside range</span></span>
<span id="cb19-10">yfb, ylb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveform[xfb], waveform[xlb]</span>
<span id="cb19-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ...</span></span></code></pre></div>
<div class="cell-output cell-output-error">
<pre><code>IndexError: index 520 is out of bounds for axis 0 with size 520</code></pre>
</div>
</div>
<p>The code is failing because it’s not possible to find the x coordinates for the segment last crossing the threshold. This results in a value of <img src="https://latex.codecogs.com/png.latex?x_%7Blb%7D"> of 520 that is outside the range of the array (which starts from 0 to 519). A possible solution could be to set the values of <img src="https://latex.codecogs.com/png.latex?x_%7Blb%7D"> to be 0 or <code>np.nan</code> in case they are found to be 520. This would result in a time over threshold of 0. This is the cleaniest solution I could find:</p>
<div class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1">waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9</span>, :]</span>
<span id="cb21-2">samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold</span>
<span id="cb21-3">xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb21-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set xfb to be nan in case no threshold crossing</span></span>
<span id="cb21-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># is found. The same for xlb</span></span>
<span id="cb21-6">xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, xfb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb21-7">xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) </span>
<span id="cb21-8">xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> window_length, xlb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb21-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The corresponding yfb and ylb are easy to get:</span></span>
<span id="cb21-10">yfb, ylb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveform[xfb], waveform[xlb]</span>
<span id="cb21-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ... time over threshold will result in a 0 value</span></span></code></pre></div>
</div>
</section>
<section id="the-2d-case-1" class="level2">
<h2 class="anchored" data-anchor-id="the-2d-case-1">The 2d case</h2>
<p>The 2d case is a bit more complicated as it involves the usual <code>numpy</code> model to solve this problem in an efficient way. Nevertheless, the steps to approach the problem are the same so the code looks like the following:</p>
<div class="cell" data-execution_count="286">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1">samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold</span>
<span id="cb22-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the indices xfb and xlb</span></span>
<span id="cb22-3">xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb22-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add np.where condition to handle signal without threshold crossing</span></span>
<span id="cb22-5">xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, xfb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb22-6">xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[:, ::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb22-7">xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> window_length, xlb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb22-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Taking indices along a 2d array is a bit</span></span>
<span id="cb22-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># more complicated. There are few different</span></span>
<span id="cb22-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ways to do it</span></span>
<span id="cb22-11">yfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xfb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb22-12">ylb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xlb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb22-13"></span>
<span id="cb22-14">xfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb22-15">yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xfb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb22-16">xla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb22-17">yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xlb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb22-18"></span>
<span id="cb22-19">xf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (xfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xfb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb))</span>
<span id="cb22-20">xl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (xla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xlb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb))</span>
<span id="cb22-21">time_over_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xf</span>
<span id="cb22-22"></span>
<span id="cb22-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Let's visualize everything</span></span>
<span id="cb22-24">fig, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb22-25"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ix, waveform <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(waveforms):</span>
<span id="cb22-26">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axs.flat[ix]</span>
<span id="cb22-27">    ax.plot(waveform, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.-'</span>)</span>
<span id="cb22-28">    ax.axvline(xfb[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb22-29">    ax.axvline(xf[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C2'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb22-30">    ax.axvline(xfa[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb22-31"></span>
<span id="cb22-32">    ax.axvline(xlb[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb22-33">    ax.axvline(xl[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C2'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb22-34">    ax.axvline(xla[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb22-35"></span>
<span id="cb22-36">    ax.axhline(threshold, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb22-37"></span>
<span id="cb22-38">    ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(xfb[ix] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, xla[ix] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), </span>
<span id="cb22-39">    ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>),</span>
<span id="cb22-40">    title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Waveform </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Time over threshold = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>time_over_threshold[ix]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> samples'</span>)</span>
<span id="cb22-41">    fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_389329/2995661854.py:20: RuntimeWarning: divide by zero encountered in true_divide
  xl = xlb + (xla - xlb) * ((threshold - ylb) / (yla - ylb))</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/index_files/figure-html/cell-14-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>You may notice that there are few corner cases that may arise. For instance, have a look at waveform 5: the resulting time over threshold is <code>nan</code>. In this case, if the segment defined by <img src="https://latex.codecogs.com/png.latex?(x_%7Blb%7D,%20y_%7Blb%7D),%20(x_%7Bla%7D,%20y_%7Bla%7D)"> and crossing the threshold is parallel to the threshold itself, the values of either <img src="https://latex.codecogs.com/png.latex?y_%7Bfa%7D%20-%20y_%7Bfb%7D"> or <img src="https://latex.codecogs.com/png.latex?y_%7Bla%7D%20-%20y_%7Blb%7D"> are equal to 0, resulting in an error similar to:</p>
<pre><code>RuntimeWarning: invalid value encountered in true_divide
  xl = xlb + (xla - xlb) * ((threshold - ylb) / (yla - ylb))</code></pre>
<p>A possible solution to this is to handle the division using <code>np.divide</code>, which allows to use a <code>where</code> option and that allows to avoid to <code>try/catch</code> or use a context manager to handle the error. For more information see this <a href="https://stackoverflow.com/questions/26248654/how-to-return-0-with-divide-by-zero">Stack overflow post</a>.</p>
<p>The code above will become the following:</p>
<div class="cell" data-execution_count="285">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1">samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold</span>
<span id="cb25-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the indices xfb and xlb</span></span>
<span id="cb25-3">xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb25-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add np.where condition to handle signal without threshold crossing</span></span>
<span id="cb25-5">xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, xfb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb25-6">xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[:, ::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb25-7">xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> window_length, xlb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb25-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Taking indices along a 2d array is a bit</span></span>
<span id="cb25-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># more complicated. There are few different</span></span>
<span id="cb25-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ways to do it</span></span>
<span id="cb25-11">yfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xfb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb25-12">ylb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xlb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb25-13"></span>
<span id="cb25-14">xfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb25-15">yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xfb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb25-16">xla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb25-17">yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xlb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb25-18"></span>
<span id="cb25-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># temp_yf and temp_yl are the arrays to use in case the 'where' condition is False. </span></span>
<span id="cb25-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the 'where' condition is true, then the np.divide() result is used instead</span></span>
<span id="cb25-21">temp_yf, temp_yl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros_like(yfa, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'float64'</span>), np.zeros_like(ylb, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'float64'</span>)</span>
<span id="cb25-22">xf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (xfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xfb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (np.divide((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb) , (yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb), out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>temp_yf, where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb25-23">xl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (xla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xlb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (np.divide((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb) , (yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb), out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>temp_yl, where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb25-24">time_over_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xf</span>
<span id="cb25-25"></span>
<span id="cb25-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Let's visualize everything</span></span>
<span id="cb25-27">fig, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb25-28"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ix, waveform <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(waveforms):</span>
<span id="cb25-29">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axs.flat[ix]</span>
<span id="cb25-30">    ax.plot(waveform, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.-'</span>)</span>
<span id="cb25-31">    ax.axvline(xfb[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb25-32">    ax.axvline(xf[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C2'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb25-33">    ax.axvline(xfa[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb25-34"></span>
<span id="cb25-35">    ax.axvline(xlb[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb25-36">    ax.axvline(xl[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C2'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb25-37">    ax.axvline(xla[ix], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C3'</span>)</span>
<span id="cb25-38"></span>
<span id="cb25-39">    ax.axhline(threshold, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'C1'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb25-40"></span>
<span id="cb25-41">    ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(xlim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(xfb[ix] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, xla[ix] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), </span>
<span id="cb25-42">    ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>),</span>
<span id="cb25-43">    title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Waveform </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Time over threshold = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>time_over_threshold[ix]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> samples'</span>)</span>
<span id="cb25-44">    fig.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/index_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="handling-corner-cases" class="level2">
<h2 class="anchored" data-anchor-id="handling-corner-cases">Handling corner cases</h2>
<p>Unfortunately, the code below does not handle all the cases. Let’s wrap the previous code into a function and prepare some test cases</p>
<div class="cell" data-execution_count="508">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> compute_time_over_threshold(data: np.ndarray, threshold: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray: </span>
<span id="cb26-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Compute the time over threshold for a 1d or 2d array given a fixed threshold. The</span></span>
<span id="cb26-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    time over threshold is defined as the difference between the intersection of the</span></span>
<span id="cb26-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    threshold with the segments of the samples: the last - the first segments</span></span>
<span id="cb26-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    crossing this threshold define the tot. In case no samples cross the</span></span>
<span id="cb26-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    tot, the resulting value is 0.as_integer_ratio</span></span>
<span id="cb26-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb26-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb26-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb26-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    data: ndarray</span></span>
<span id="cb26-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        1d or 2d array of shape (n_waveforms, n_samples)</span></span>
<span id="cb26-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    threshold: float or int or ndarray (n_waveforms)</span></span>
<span id="cb26-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        a fixed threshold for all the waveforms or a set of threshold</span></span>
<span id="cb26-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        for each waveform</span></span>
<span id="cb26-15"></span>
<span id="cb26-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb26-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb26-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    out: ndarray</span></span>
<span id="cb26-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        a 1d array of the time over thresholds of shape (n_waveforms)</span></span>
<span id="cb26-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb26-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># In case of a 1d array of shape (n_samples), convert it to a 2d</span></span>
<span id="cb26-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># array of shape (1, n_samples), so that the code can be used for</span></span>
<span id="cb26-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># both 1d and 2d array</span></span>
<span id="cb26-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> data.ndim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb26-25">        waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, :]</span>
<span id="cb26-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb26-27">        waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data</span>
<span id="cb26-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The same operation for threshold:</span></span>
<span id="cb26-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(threshold, np.ndarray):</span>
<span id="cb26-30">        threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([threshold])</span>
<span id="cb26-31"></span>
<span id="cb26-32">    window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb26-33">    </span>
<span id="cb26-34">    samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb26-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find the indices xfb and xlb</span></span>
<span id="cb26-36">    xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb26-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add np.where condition to handle signal without threshold crossing</span></span>
<span id="cb26-38">    xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, xfb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb26-39">    xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[:, ::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb26-40">    xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, xlb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb26-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Taking indices along a 2d array is a bit</span></span>
<span id="cb26-42">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># more complicated. There are few different</span></span>
<span id="cb26-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ways to do it</span></span>
<span id="cb26-44">    yfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xfb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb26-45">    ylb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xlb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb26-46"></span>
<span id="cb26-47">    xfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb26-48">    yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xfb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb26-49">    xla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb26-50">    yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xlb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb26-51"></span>
<span id="cb26-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># temp_yf and temp_yl are the arrays to use in case the 'where' condition is False. </span></span>
<span id="cb26-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the 'where' condition is true, then the np.divide() result is used instead</span></span>
<span id="cb26-54">    temp_yf, temp_yl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros_like(yfa, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'float64'</span>), np.zeros_like(ylb, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'float64'</span>)</span>
<span id="cb26-55">    xf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (xfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xfb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (np.divide((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb) , (yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb), out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>temp_yf, where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb26-56">    xl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (xla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xlb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (np.divide((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb) , (yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb), out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>temp_yl, where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb26-57">    time_over_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xf</span>
<span id="cb26-58"></span>
<span id="cb26-59">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> time_over_threshold</span>
<span id="cb26-60"></span>
<span id="cb26-61">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb26-62">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb26-63">tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compute_time_over_threshold(waveform_test, threshold_test)</span>
<span id="cb26-64">expected_tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb26-65">tot, expected_tot</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="508">
<pre><code>(array([0.]), array([4]))</code></pre>
</div>
</div>
<p>Here I wrapped everything into a function and added few initial lines of codes to transform a 1d array into a 2d array with the first dimension set to 1. This allows me to reuse the same code for the case in which we have a single waveform or multiple ones. The same applies for the threshold: if it is a scalar then it’s converted to a 1d array.</p>
<p>Let’s test the function with a simple case: there are no points going below the threshold:</p>
<div class="cell" data-execution_count="504">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb28-2">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb28-3">tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compute_time_over_threshold(waveform_test, threshold_test)</span>
<span id="cb28-4">expected_tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb28-5">tot, expected_tot</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="504">
<pre><code>(array([0.]), array([0]))</code></pre>
</div>
</div>
<p>So far so good. Now I want to test a simple case in which the time over threshold should be a simple scalar value.</p>
<div class="cell" data-execution_count="505">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb30-2">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb30-3">tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compute_time_over_threshold(waveform_test, threshold_test)</span>
<span id="cb30-4">expected_tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb30-5">tot, expected_tot</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="505">
<pre><code>(array([3.]), array([3]))</code></pre>
</div>
</div>
<p>The time over threshold is working fine in this case. Few other corners cases: all samples are below threshold, so the computed time over threshold should be equal to the window length</p>
<div class="cell" data-execution_count="507">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb32-2">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb32-3">tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compute_time_over_threshold(waveform_test, threshold_test)</span>
<span id="cb32-4">expected_tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb32-5">tot, expected_tot</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="507">
<pre><code>(array([0.]), array([4]))</code></pre>
</div>
</div>
<p>In this case the time over threshold is not computed properly. The issue arises due to the way <code>xlb</code> is handled. In particular, in line <code>40</code>, the part <code>xlb = np.where(xlb != window_length - 1, xlb, 0)</code> is setting the values of <code>xlb</code> to 0 in case <code>xlb == window_length - 1</code>. The problem is that there are two cases in which <code>xlb</code> could be equal to <code>window_length - 1</code>. One case is when the last sample is actually the last crossing the threshold. The second is the one where no samples are crossing the threshold, so <code>np.argmax()</code> returns the first item of the array, which in the reversed case is <code>window_length - 1</code>.</p>
<p>For this reason, it is important to distinguish the two cases and handle them separately. In the case of two conditions <code>xlb == window_length - 1</code> and <code>np.all(samples_below_threshold == True, axis=1)</code> happening at the same time then all the samples are already below the threshold, thus the time over threshold will be equal to the <code>window_length</code>. Instead, in the case of <code>xlb == window_length - 1</code> and <code>np.any(samples_below_threshold == True, axis=1)</code> it means there is at least one sample below the threshold so we can calculate the time over threshold as expected. It could be all the samples but in that case we would fall into the previous condition, so it should be already handled.</p>
<p>Additionally, <code>xla</code> should be also modified: if <code>xlb == window_length - 1</code> then it means the last sample is still below the threshold, so <code>xla</code> can be set to be equal to <code>xlb</code> in order to compute the time over threshold on the last point (which is a segment delimited by <img src="https://latex.codecogs.com/png.latex?x_%7Bla%7D,%20x_%7Blb%7D">, so a segment with length 0). Otherwsise, <code>xlb</code> can be set to <code>xla + 1</code> as usual.</p>
<p>Below the updated code:</p>
<div class="cell" data-execution_count="509">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> compute_time_over_threshold(data: np.ndarray, threshold: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray: </span>
<span id="cb34-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Compute the time over threshold for a 1d or 2d array given a fixed threshold. The</span></span>
<span id="cb34-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    time over threshold is defined as the difference between the intersection of the</span></span>
<span id="cb34-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    threshold with the segments of the samples: the last - the first segments</span></span>
<span id="cb34-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    crossing this threshold define the tot. In case no samples cross the</span></span>
<span id="cb34-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    tot, the resulting value is 0.as_integer_ratio</span></span>
<span id="cb34-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb34-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb34-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb34-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    data: ndarray</span></span>
<span id="cb34-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        1d or 2d array of shape (n_waveforms, n_samples)</span></span>
<span id="cb34-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    threshold: float or int or ndarray (n_waveforms)</span></span>
<span id="cb34-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        a fixed threshold for all the waveforms or a set of threshold</span></span>
<span id="cb34-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        for each waveform</span></span>
<span id="cb34-15"></span>
<span id="cb34-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb34-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb34-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    out: ndarray</span></span>
<span id="cb34-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        a 1d array of the time over thresholds of shape (n_waveforms)</span></span>
<span id="cb34-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb34-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># In case of a 1d array of shape (n_samples), convert it to a 2d</span></span>
<span id="cb34-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># array of shape (1, n_samples), so that the code can be used for</span></span>
<span id="cb34-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># both 1d and 2d array</span></span>
<span id="cb34-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> data.ndim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb34-25">        waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, :]</span>
<span id="cb34-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb34-27">        waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data</span>
<span id="cb34-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The same operation for threshold:</span></span>
<span id="cb34-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(threshold, np.ndarray):</span>
<span id="cb34-30">        threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([threshold])</span>
<span id="cb34-31">    </span>
<span id="cb34-32">    samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb34-33">    window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb34-34"></span>
<span id="cb34-35">    xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb34-36">    xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, xfb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb34-37">    xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[:, ::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb34-38">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Notice I removed the np.where() condition on xlb</span></span>
<span id="cb34-39"></span>
<span id="cb34-40">    yfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xfb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb34-41">    ylb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xlb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb34-42"></span>
<span id="cb34-43">    xfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb34-44">    yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xfa[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb34-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Here I put a condition on xla: if xlb is the last item, then xla</span></span>
<span id="cb34-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># should be the same as xlb, so the segment (xlb-xla) is of length 0</span></span>
<span id="cb34-47">    xla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, xlb, xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb34-48">    yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xla[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb34-49"></span>
<span id="cb34-50">    xf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (np.divide((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb) , (yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb), out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.zeros_like(yfa, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'float64'</span>), where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>((yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)))</span>
<span id="cb34-51">    xl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (np.divide((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb) , (yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb), out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.zeros_like(yfa, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'float64'</span>), where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>((yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)))</span>
<span id="cb34-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use np.select() as a case statement:</span></span>
<span id="cb34-53">    time_over_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.select(condlist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb34-54">        (xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>(samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># all points crossing threshold</span></span>
<span id="cb34-55">        (xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># at least one point crossing threshold</span></span>
<span id="cb34-56">        (xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>(samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no real points crossing threshold</span></span>
<span id="cb34-57">        (xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># last point crossing threshold</span></span>
<span id="cb34-58">    ], choicelist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb34-59">        window_length,</span>
<span id="cb34-60">        xl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>xf,</span>
<span id="cb34-61">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb34-62">        xl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>xf</span>
<span id="cb34-63">    ])</span>
<span id="cb34-64">    </span>
<span id="cb34-65">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> time_over_threshold</span></code></pre></div>
</div>
<p>As you can see I removed the <code>np.where()</code> condition onf <code>xlb</code> and added one on <code>xla</code>. If I didn’t, then when <code>xlb</code> is equal to <code>window_length - 1</code>, <code>xla</code> would be equal to <code>window_length</code>, resulting in an error when trying to access the array since the last item is at <code>window_length - 1</code>.</p>
<p>Also, I added <code>np.select()</code> which I usually think of as a n-dimensional version of a case statement. In case <code>xlb != window_length - 1</code> there could be either all points crossing the threshold or at least one, so the time over threshold would be either the whole <code>window_length</code> or the computed <code>xl - xf</code> value.</p>
<p>In case <code>xlb == window_length - 1</code> then there could be either no points at all crossing the threshold (<code>time_over_threshold = 0</code>) or there could be only the lat one crossing it, so the time over threshold would be again computed in the standard way of <code>xl - xf</code>.</p>
<p>Now the case in which the first sample is already below the threshold but not the last is correctly handled:</p>
<div class="cell" data-execution_count="511">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb35-2">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb35-3">tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compute_time_over_threshold(waveform_test, threshold_test)</span>
<span id="cb35-4">expected_tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>])</span>
<span id="cb35-5">tot, expected_tot</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="511">
<pre><code>(array([2.5]), array([2.5]))</code></pre>
</div>
</div>
<p>Here below you can find the final the final code I use for the time over threshold calculation and few test cases:</p>
<div class="cell" data-execution_count="404">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> compute_time_over_threshold(data: np.ndarray, threshold: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> np.ndarray) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> np.ndarray: </span>
<span id="cb37-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Compute the time over threshold for a 1d or 2d array given a fixed threshold. The</span></span>
<span id="cb37-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    time over threshold is defined as the difference between the intersection of the</span></span>
<span id="cb37-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    threshold with the segments of the samples: the last - the first segments</span></span>
<span id="cb37-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    crossing this threshold define the tot. In case no samples cross the</span></span>
<span id="cb37-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    tot, the resulting value is 0.as_integer_ratio</span></span>
<span id="cb37-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb37-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters</span></span>
<span id="cb37-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    ----------</span></span>
<span id="cb37-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    data: ndarray</span></span>
<span id="cb37-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        1d or 2d array of shape (n_waveforms, n_samples)</span></span>
<span id="cb37-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    threshold: float or int or ndarray (n_waveforms)</span></span>
<span id="cb37-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        a fixed threshold for all the waveforms or a set of threshold</span></span>
<span id="cb37-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        for each waveform</span></span>
<span id="cb37-15"></span>
<span id="cb37-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns</span></span>
<span id="cb37-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    -------</span></span>
<span id="cb37-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    out: ndarray</span></span>
<span id="cb37-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        a 1d array of the time over thresholds of shape (n_waveforms)</span></span>
<span id="cb37-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb37-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># In case of a 1d array of shape (n_samples), convert it to a 2d</span></span>
<span id="cb37-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># array of shape (1, n_samples), so that the code can be used for</span></span>
<span id="cb37-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># both 1d and 2d array</span></span>
<span id="cb37-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> data.ndim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb37-25">        waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, :]</span>
<span id="cb37-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb37-27">        waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data</span>
<span id="cb37-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The same operation for threshold:</span></span>
<span id="cb37-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(threshold, np.ndarray):</span>
<span id="cb37-30">        threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([threshold])</span>
<span id="cb37-31">    </span>
<span id="cb37-32">    samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb37-33">    window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb37-34"></span>
<span id="cb37-35">    xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb37-36">    xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, xfb, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb37-37">    xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[:, ::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb37-38"></span>
<span id="cb37-39">    yfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xfb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb37-40">    ylb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xlb[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb37-41"></span>
<span id="cb37-42">    xfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb37-43">    yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xfa[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb37-44">    xla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.where(xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, xlb, xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb37-45">    yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.take_along_axis(waveforms, xla[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).flatten()</span>
<span id="cb37-46"></span>
<span id="cb37-47">    xf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xfb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (np.divide((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb) , (yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb), out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.zeros_like(yfa, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'float64'</span>), where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>((yfa <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yfb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)))</span>
<span id="cb37-48">    xl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (np.divide((threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb) , (yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb), out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.zeros_like(yfa, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'float64'</span>), where<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>((yla <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ylb) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)))</span>
<span id="cb37-49">    time_over_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.select(condlist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb37-50">        (xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>(samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># all points crossing threshold</span></span>
<span id="cb37-51">        (xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># at least one point crossing threshold</span></span>
<span id="cb37-52">        (xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span>(samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no real point crossing threshold</span></span>
<span id="cb37-53">        (xlb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> window_length <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">any</span>(samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># last point</span></span>
<span id="cb37-54">    ], choicelist<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[</span>
<span id="cb37-55">        window_length,</span>
<span id="cb37-56">        xl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>xf,</span>
<span id="cb37-57">        <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb37-58">        xl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>xf</span>
<span id="cb37-59">    ])</span>
<span id="cb37-60">    </span>
<span id="cb37-61">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> time_over_threshold</span></code></pre></div>
</details>
</div>
<p>Few test cases here below:</p>
<div class="cell" data-execution_count="405">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb38-2">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb38-3">compute_time_over_threshold(waveform_test, threshold_test)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="405">
<pre><code>array([8.])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="406">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb40-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb40-2">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb40-3">compute_time_over_threshold(waveform_test, threshold_test)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="406">
<pre><code>array([0.])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="407">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb42-2">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb42-3">compute_time_over_threshold(waveform_test, threshold_test)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="407">
<pre><code>array([4.5])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="408">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])</span>
<span id="cb44-2">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb44-3">compute_time_over_threshold(waveform_test, threshold_test)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="408">
<pre><code>array([5.66666667])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="409">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb46-2">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb46-3">compute_time_over_threshold(waveform_test, threshold_test)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="409">
<pre><code>array([3.16666667])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="413">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb48-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb48-2">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span></span>
<span id="cb48-3">compute_time_over_threshold(waveform_test, threshold_test)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="413">
<pre><code>array([3.4])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="414">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([</span>
<span id="cb50-2">    [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb50-3">    [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb50-4">])</span>
<span id="cb50-5">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span></span>
<span id="cb50-6">compute_time_over_threshold(waveform_test, threshold_test)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="414">
<pre><code>array([3.13333333, 0.        ])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="343">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1">waveform_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([</span>
<span id="cb52-2">    [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb52-3">    [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb52-4">])</span>
<span id="cb52-5">threshold_test <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb52-6">compute_time_over_threshold(waveform_test, threshold_test)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="343">
<pre><code>array([3.13333333, 0.61904762])</code></pre>
</div>
</div>
</section>
</section>
<section id="why-i-needed-linear-interpolation" class="level1">
<h1>Why I needed linear interpolation</h1>
<p>The readout system I use to sample signal is poorly resoluted compared to the average time over threshold of the signals, so I wanted to have a linear interpolation to allow me to compute proper distributions of the time over threshold. This is possible thanks to the intrinsic time jitter of the digitizer which is of few order of magnitude lower than its sampling frequency.</p>
<p>For example, a digitizer can have a sampling frequency of 500 Ms/s but a time jitter (or time resolution) of 50 ps.</p>
<p>The two plots here below shows the difference between using the simple version of the time over threshold and the implemented one.</p>
<div class="cell" data-execution_count="512">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1">n_waveforms, n_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10_000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb54-2">threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb54-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generated some fake data of 10_000 waveforms of 20 samples each</span></span>
<span id="cb54-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># with values between -10 and 0</span></span>
<span id="cb54-5">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.tile(np.arange(n_samples), n_waveforms).reshape((n_waveforms, n_samples))</span>
<span id="cb54-6">noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(n_waveforms, n_samples) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb54-7">waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise</span>
<span id="cb54-8"></span>
<span id="cb54-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simple version of the time over threshold</span></span>
<span id="cb54-10">samples_below_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold</span>
<span id="cb54-11">first_items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.argmax(samples_below_threshold, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb54-12">last_items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> waveforms.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.argmax(samples_below_threshold[:, ::<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb54-13">simple_tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> last_items <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> first_items</span>
<span id="cb54-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Linearly interpolated version of the time over threshold</span></span>
<span id="cb54-15">interpolated_tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> compute_time_over_threshold(waveforms, threshold)</span>
<span id="cb54-16"></span>
<span id="cb54-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the two time over threshold distributions</span></span>
<span id="cb54-18">fig, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb54-19">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb54-20">ax.plot(waveforms[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, :].T, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb54-21">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Waveforms'</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time samples'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ADC value'</span>)</span>
<span id="cb54-22"></span>
<span id="cb54-23">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb54-24">ax.hist(simple_tot, bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), histtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'step'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Simple. Mean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>simple_tot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb54-25">ax.hist(interpolated_tot, bins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"auto"</span>, histtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'step'</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Interpolated. Mean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>interpolated_tot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.1f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, density<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb54-26">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time Over Threshold distribution'</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time [ns]'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normalized counts'</span>)</span>
<span id="cb54-27">ax.legend()</span>
<span id="cb54-28"></span>
<span id="cb54-29">fig.tight_layout()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/time-over-threshold-in-signals/index_files/figure-html/cell-31-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>It is easily visible that with a set of synthetic signals the time resolution computed with the simple sampling is different from the one computed with a linear interpolation.</p>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>In this post I have tried to calculate the time over threshold in the “classical” way, but also by linearly interpolating the threshold with the points of the sampled signal to achieve a better resolution. The 1-dimensional case is fairly straight forward, but the 2-dimensional case had me think a bit about the best way to implement the solution.</p>
<p>Perhaps there are better or easier ways to do this but I couldn’t find anything on the internet so I had to figure it out by myself. If anyone comes up with a cleaner or better solution I will update this poit.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>matplotlib</category>
  <category>scipy</category>
  <category>numpy</category>
  <category>signal processing</category>
  <category>signal analysis</category>
  <guid>https://grigolet.github.io/posts/time-over-threshold-in-signals/index.html</guid>
  <pubDate>Thu, 29 Sep 2022 22:00:00 GMT</pubDate>
  <media:content url="https://grigolet.github.io/posts/time-over-threshold-in-signals/graph.png" medium="image" type="image/png" height="66" width="144"/>
</item>
<item>
  <title>My matplotlib stylesheet</title>
  <link>https://grigolet.github.io/posts/my-matplotlib-stylesheet/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>When working on R&amp;D of gasesous detectors I tend to produce lots of plots for internal group discussions, conference presentations and publication publishing. Since most of these plots shows performance relative to gaseous detectors and since I am based at CERN I get to see lot of similar plots made by some other groups using <a href="https://root.cern.ch/">ROOT</a>, the de-facto standard analysis tool for high energy physics.</p>
<p>If I really have to be honest I have never liked ROOT so much, although I understand it provides several useful tools, from plotting data and fitting functions to GUI toolkits. Most, if not all the plots regarding the discovery of the Higgs boson were produced using ROOT. The layout of ROOT plots is then recognized and approved by the majority of the community in high energy physics.</p>
<p>If we have to compare a default plot made using root versus a default plot made with matplotlib, this would be the result</p>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ROOT <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> rt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-4"></span>
<span id="cb1-5">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">321.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">860.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">777.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">562.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">374.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">132.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">816.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">220.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">253.0</span>])</span>
<span id="cb1-6">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">134.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">307.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">299.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">213.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">135.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">297.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">85.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">95.0</span>])</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Let's just make sure we are using the default settings now</span></span>
<span id="cb1-9">plt.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'default'</span>)</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matplotlib</span></span>
<span id="cb1-12">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb1-13">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Rate vs. Currents'</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Rate [Hz/cm$^2$]'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Currents [uA]'</span>)</span>
<span id="cb1-14">ax.plot(x, y, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>)</span>
<span id="cb1-15">ax.axhline(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>)</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ROOT</span></span>
<span id="cb1-18">canvas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt.TCanvas(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rate_vs_current"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rate vs. Currents"</span>)</span>
<span id="cb1-19">graph <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt.TGraph(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x), x, y)</span>
<span id="cb1-20">graph.SetTitle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rate vs. Currents"</span>)</span>
<span id="cb1-21">graph.SetMarkerStyle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb1-22">graph.GetXaxis().SetTitle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rate [Hz/cm^</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{2}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">]"</span>)</span>
<span id="cb1-23">graph.GetYaxis().SetTitle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Currents [uA]"</span>)</span>
<span id="cb1-24">line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt.TLine(graph.GetXaxis().GetXmin(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, graph.GetXaxis().GetXmax(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>)</span>
<span id="cb1-25">line.SetLineColor(rt.kRed)</span>
<span id="cb1-26">graph.Draw(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP'</span>)</span>
<span id="cb1-27">line.Draw(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L"</span>)</span>
<span id="cb1-28">canvas.Draw()</span></code></pre></div>
</details>
<div class="cell quarto-layout-panel" data-execution_count="14">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-default-matplotlib" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/my-matplotlib-stylesheet/index_files/figure-html/fig-default-matplotlib-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Default matplotlib plot</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-default-matplotlib" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/my-matplotlib-stylesheet/index_files/figure-html/fig-default-matplotlib-output-2.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Default ROOT plot</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="styling-matplotlib-plots" class="level1">
<h1>Styling matplotlib plots</h1>
<p>My goal here is to have the matplotlib plot to look a bit more like the ROOT one. I recently came to find that there is a python package called <a href="https://github.com/scikit-hep/mplhep">mplhep</a> that is aiming at producing ROOT-like style plots used in high energy physics. I found the package to be really helpful, especially when there is the need to add some labels regarding collaborations. However, in my particular case, I noticed that the default axes ticks, labels, spines layout were matching more matplotlib defaults than ROOT ones.</p>
<p>Before I came to know <code>mplhep</code> I decided to create my own <a href="https://matplotlib.org/stable/tutorials/introductory/customizing.html#matplotlibrc-sample">matplotlibrc</a> file, which, as the name may suggest, is a file containing defaults used to style matplotlib plots.</p>
<p>If you have a look at the default <code>matplotlibrc</code> content, you could see that it is organized in sections. Within each section you can find a set of defaults.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>default_matplotlibrc.txt</strong></pre>
</div>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource txt number-lines code-with-copy"><code class="sourceCode default"><span id="cb2-1">...</span>
<span id="cb2-2">## Matplotlib configuration are currently divided into following parts:</span>
<span id="cb2-3">##     - BACKENDS</span>
<span id="cb2-4">##     - LINES</span>
<span id="cb2-5">##     - PATCHES</span>
<span id="cb2-6">##     - HATCHES</span>
<span id="cb2-7">##     - BOXPLOT</span>
<span id="cb2-8">##     - FONT</span>
<span id="cb2-9">##     - TEXT</span>
<span id="cb2-10">##     - LaTeX</span>
<span id="cb2-11">##     - AXES</span>
<span id="cb2-12">##     - DATES</span>
<span id="cb2-13">##     - TICKS</span>
<span id="cb2-14">##     - GRIDS</span>
<span id="cb2-15">##     - LEGEND</span>
<span id="cb2-16">##     - FIGURE</span>
<span id="cb2-17">##     - IMAGES</span>
<span id="cb2-18">##     - CONTOUR PLOTS</span>
<span id="cb2-19">##     - ERRORBAR PLOTS</span>
<span id="cb2-20">##     - HISTOGRAM PLOTS</span>
<span id="cb2-21">##     - SCATTER PLOTS</span>
<span id="cb2-22">##     - AGG RENDERING</span>
<span id="cb2-23">##     - PATHS</span>
<span id="cb2-24">##     - SAVING FIGURES</span>
<span id="cb2-25">##     - INTERACTIVE KEYMAPS</span>
<span id="cb2-26">##     - ANIMATION</span>
<span id="cb2-27">...</span></code></pre></div>
</div>
<p>I will detail the sections that I have modified to make plots look more like ROOT ones.</p>
<section id="lines" class="level2">
<h2 class="anchored" data-anchor-id="lines">LINES</h2>
<p>In the <code>LINES</code> section the only default value that I have changed is the <code>lines.linewidth</code> set to 0.5, instead of the 1.5 default value.</p>
</section>
<section id="patches" class="level2">
<h2 class="anchored" data-anchor-id="patches">PATCHES</h2>
<p>In the <code>PATCHES</code> section I have also decrease the <code>patch.linewidth</code> to 0.5</p>
</section>
<section id="font" class="level2">
<h2 class="anchored" data-anchor-id="font">FONT</h2>
<p>For the font I haven’t found any easy way to add a web font into matplotlib without adding some lines of code. For this reason I have installed GNU Free font and modified the order of the <code>sans-serif</code> font to be: <code>Helvetica, FreeSans, Nimbus Sans, DejaVu Sans, Bitstream Vera Sans, Computer Modern Sans Serif, Lucida Grande, Verdana, Geneva, Lucid, Arial, Avant Garde, sans-serif</code></p>
<p>In the <code>FONT</code> section I have set <code>font.weight</code> to <code>regular</code> by default.</p>
</section>
<section id="axes-and-axis" class="level2">
<h2 class="anchored" data-anchor-id="axes-and-axis">AXES and AXIS</h2>
<p>In the <code>AXES</code> and <code>AXIS</code> sections I tweaked multiple lines. I will report only the modified lines:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>my_matplotlibrc.txt</strong></pre>
</div>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource txt number-lines code-with-copy"><code class="sourceCode default"><span id="cb3-1"># AXES</span>
<span id="cb3-2">axes.grid           : False   ## display grid or not</span>
<span id="cb3-3">axes.labelsize      : x-large  ## fontsize of the x any y labels</span>
<span id="cb3-4">axes.labelweight    : regular  ## weight of the x and y labels</span>
<span id="cb3-5">axes.formatter.useoffset      : False    ## If True, the tick label formatter</span>
<span id="cb3-6">axes.formatter.offset_threshold : 2     ## When useoffset is True, the offset</span>
<span id="cb3-7">...</span>
<span id="cb3-8"># AXIS</span>
<span id="cb3-9">xaxis.labellocation: right  # alignment of the xaxis label: {left, right, center}</span>
<span id="cb3-10">yaxis.labellocation: top  # alignment of the yaxis label: {bottom, top, center}</span></code></pre></div>
</div>
</section>
<section id="ticks" class="level2">
<h2 class="anchored" data-anchor-id="ticks">TICKS</h2>
<p>Matplotlib’s tick layout is what differs the most from ROOT default’s style. In this case the modified lines were the following:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>my_matplotlibrc.txt</strong></pre>
</div>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource txt number-lines code-with-copy"><code class="sourceCode default"><span id="cb4-1">xtick.top            : True  ## draw ticks on the top side</span>
<span id="cb4-2">xtick.major.size     : 8    ## major tick size in points</span>
<span id="cb4-3">xtick.minor.size     : 4      ## minor tick size in points</span>
<span id="cb4-4">xtick.major.width    : 0.5    ## major tick width in points</span>
<span id="cb4-5">xtick.minor.width    : 0.5    ## minor tick width in points</span>
<span id="cb4-6">xtick.major.pad      : 6    ## distance to major tick label in points</span>
<span id="cb4-7">xtick.direction      : in    ## direction: in, out, or inout</span>
<span id="cb4-8">xtick.minor.visible  : True  ## visibility of minor ticks on x-axis</span>
<span id="cb4-9">ytick.right          : True   ## draw ticks on the right side</span>
<span id="cb4-10">ytick.major.size     : 8      ## major tick size in points</span>
<span id="cb4-11">ytick.minor.size     : 4      ## minor tick size in points</span>
<span id="cb4-12">ytick.major.width    : 0.5    ## major tick width in points</span>
<span id="cb4-13">ytick.minor.width    : 0.5    ## minor tick width in points</span>
<span id="cb4-14">ytick.major.pad      : 6    ## distance to major tick label in points</span>
<span id="cb4-15">ytick.direction      : in     ## direction: in, out, or inout</span>
<span id="cb4-16">ytick.minor.visible  : True  ## visibility of minor ticks on y-axis</span></code></pre></div>
</div>
</section>
<section id="grid" class="level2">
<h2 class="anchored" data-anchor-id="grid">GRID</h2>
<p>Although I used to love grid, they might make the plot a bit “heavy” to read when there are several points and lines. For this reason I kept grids disabled:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>my_matplotlibrc.txt</strong></pre>
</div>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource txt number-lines code-with-copy"><code class="sourceCode default"><span id="cb5-1">grid.color       :   k    ## black</span>
<span id="cb5-2">grid.linestyle   :   --         ## dashed</span>
<span id="cb5-3">grid.linewidth   :   0.5       ## in points</span></code></pre></div>
</div>
</section>
<section id="legend" class="level2">
<h2 class="anchored" data-anchor-id="legend">LEGEND</h2>
<p>Regardin the legend handling I got some inspirations by having a look at some common plots used within the community I am working with:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>my_matplotlibrc.txt</strong></pre>
</div>
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource txt number-lines code-with-copy"><code class="sourceCode default"><span id="cb6-1">legend.frameon       : True     ## if True, draw the legend on a background patch</span>
<span id="cb6-2">legend.framealpha    : None      ## legend patch transparency</span>
<span id="cb6-3">legend.edgecolor     : inherit      ## background patch boundary color</span>
<span id="cb6-4">legend.fancybox      : False     ## if True, use a rounded box for the</span>
<span id="cb6-5">                                 ## legend background, else a rectangle</span>
<span id="cb6-6">legend.scatterpoints : 3        ## number of scatter points</span>
<span id="cb6-7">legend.fontsize      : large</span>
<span id="cb6-8">legend.handlelength  : 0.7      ## the length of the legend lines</span>
<span id="cb6-9">legend.handleheight  : 1      ## the height of the legend handle</span>
<span id="cb6-10">legend.handletextpad : 1.2      ## the space between the legend line and legend text</span>
<span id="cb6-11">legend.borderaxespad : 1      ## the border between the axes and legend edge</span></code></pre></div>
</div>
</section>
<section id="figure" class="level2">
<h2 class="anchored" data-anchor-id="figure">FIGURE</h2>
<p>Although there are really no standard on the figure sizes I like a default 3:2 ratio and a minimum DPI of 300:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>my_matplotlibrc.txt</strong></pre>
</div>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource txt number-lines code-with-copy"><code class="sourceCode default"><span id="cb7-1">figure.figsize   : 6, 4       ## figure size in inches</span>
<span id="cb7-2">figure.dpi       : 300        ## figure dots per inch</span></code></pre></div>
</div>
</section>
<section id="other-tweakings" class="level2">
<h2 class="anchored" data-anchor-id="other-tweakings">Other tweakings</h2>
<p>I have set the cap size of the error bars, as by default is 0 and set the histogram binning to <code>"auto"</code>:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>my_matplotlibrc.txt</strong></pre>
</div>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource txt number-lines code-with-copy"><code class="sourceCode default"><span id="cb8-1">errorbar.capsize : 1.5            ## length of end cap on error bars in pixels</span>
<span id="cb8-2">hist.bins : auto                 ## The default number of histogram bins.</span>
<span id="cb8-3">                                  ## If Numpy 1.11 or later is</span>
<span id="cb8-4">                                  ## installed, may also be `auto`</span></code></pre></div>
</div>
</section>
</section>
<section id="final-results" class="level1">
<h1>Final results</h1>
<p>If I try to make again the plot in Figure Figure&nbsp;2 with these new defaults and put it side by side to a ROOT plot I get something like this:</p>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ROOT <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> rt</span>
<span id="cb9-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb9-4"></span>
<span id="cb9-5">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">321.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">860.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">777.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">562.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">374.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">132.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">816.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">220.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">253.0</span>])</span>
<span id="cb9-6">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">134.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">307.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">299.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">213.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">135.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">297.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">85.0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">95.0</span>])</span>
<span id="cb9-7"></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use a context manager to plot only this plot with newer values</span></span>
<span id="cb9-9">plt.style.use(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'https://gitlab.cern.ch/-/snippets/2223/raw/master/rpcecogas.mplstyle'</span>)</span>
<span id="cb9-10">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb9-11">ax.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Rate vs. Currents'</span>, xlabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Rate [Hz/cm$^2$]'</span>, ylabel<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Currents [uA]'</span>)</span>
<span id="cb9-12">ax.plot(x, y, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>)</span>
<span id="cb9-13">ax.axhline(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>)</span>
<span id="cb9-14"></span>
<span id="cb9-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ROOT</span></span>
<span id="cb9-16">canvas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt.TCanvas(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rate_vs_current"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rate vs. Currents"</span>)</span>
<span id="cb9-17">graph <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt.TGraph(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x), x, y)</span>
<span id="cb9-18">graph.SetTitle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rate vs. Currents"</span>)</span>
<span id="cb9-19">graph.SetMarkerStyle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb9-20">graph.GetXaxis().SetTitle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Rate [Hz/cm^</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{2}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">]"</span>)</span>
<span id="cb9-21">graph.GetYaxis().SetTitle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Currents [uA]"</span>)</span>
<span id="cb9-22">line <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rt.TLine(graph.GetXaxis().GetXmin(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>, graph.GetXaxis().GetXmax(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>)</span>
<span id="cb9-23">line.SetLineColor(rt.kRed)</span>
<span id="cb9-24">graph.Draw(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AP'</span>)</span>
<span id="cb9-25">line.Draw(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L"</span>)</span>
<span id="cb9-26">canvas.Draw()</span></code></pre></div>
</details>
<div class="cell quarto-layout-panel" data-execution_count="15">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-new-default-matplotlib" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/my-matplotlib-stylesheet/index_files/figure-html/fig-new-default-matplotlib-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Custom matplotlib plot</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div id="fig-new-default-matplotlib" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/my-matplotlib-stylesheet/index_files/figure-html/fig-new-default-matplotlib-output-2.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;4: Default ROOT plot</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
<p>As you can notice in Figure&nbsp;4, the plots look similar. I have left a bigger x and y label titles for better readability and I have left the default <code>tab10</code> matplotlib palette for colors, as I don’t like the palette handling in ROOT.</p>
<p>You can find the stylesheet I am currently using available as a gitlab snippet here: https://gitlab.cern.ch/-/snippets/2223 There are couple of ways to use a stylesheet. The first, that applies globally, is to use <code>plt.style.use(url)</code>. The second instead, could be using a context manager provided by matplotlib that allows to apply styles on a plot within the context manager itself. For more information, see the <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.rc_context.html">matplotlib documentation on <code>rc_context</code></a> There is only one caveat that I noticed when writing this post: if I use <code>rc_context</code> then I have some issues loading the system’s font and the plot will fallback to some defaults fonts. I don’t know if this is a matplotlib bug or if it is related to my local machine. I will have to investigate</p>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>In this post I highlighted the matplotlib configuration I changed to have default plots looking more like ROOT. I am making a heavy use of these styles and I have observed that very few people notice that difference between a ROOT like plot and one made with these defaults.</p>
<p>In the future I plan to revise a little bit the configuration to further improve the layout.</p>


</section>

 ]]></description>
  <category>python</category>
  <category>matplotlib</category>
  <category>plot</category>
  <category>visualization</category>
  <category>style</category>
  <guid>https://grigolet.github.io/posts/my-matplotlib-stylesheet/index.html</guid>
  <pubDate>Sat, 17 Sep 2022 22:00:00 GMT</pubDate>
  <media:content url="https://grigolet.github.io/posts/my-matplotlib-stylesheet/preview.png" medium="image" type="image/png" height="106" width="144"/>
</item>
<item>
  <title>Multiple Y axes with matplotlib</title>
  <link>https://grigolet.github.io/posts/plots-with-multiple-y-axes/index.html</link>
  <description><![CDATA[ 




<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>When working with gas systems I make intense use of the <a href="https://www.winccoa.com/documentation/WinCCOA/3.18/en_US/GettingStarted/GettingStarted-60.html">WinCC-OA trending tool</a>, which allows to plot up to 8 time series on the same panel. Each time series tpyically corresponds to the value read by a sensor of a plant so it may have different units and range. The trending tool allows to have multiple Y axes on the left side which can be adjusted in terms of range and offset.</p>
<p>I find this feature particularly helpful, especially when there is the need to quickly and explore and correlate readings of sensor from different parts of the plant</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/plots-with-multiple-y-axes/example_unicos.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">WinCC-OA/UNICOS trending tool</figcaption>
</figure>
</div>
<p>Tools like matplotlib and plotly make it easy to work with multiple series plotted on the same data but I found a bit cumbersome trying to visualize data having different scales on the same plot.</p>
</section>
<section id="the-problem-of-visualizing-many-series" class="level1">
<h1>The problem of visualizing many series</h1>
<p>Assuming we have a very simple set of <img src="https://latex.codecogs.com/png.latex?(x,%20y_n)"> series a simple plot with matplotlib may look like this:</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> rnd</span>
<span id="cb1-3"></span>
<span id="cb1-4">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-5">y1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rnd.random() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x]</span>
<span id="cb1-6">y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rnd.random() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x]</span>
<span id="cb1-7">y3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rnd.random() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x]</span>
<span id="cb1-8">y4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rnd.random() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x]</span>
<span id="cb1-9"></span>
<span id="cb1-10">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb1-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> y <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [y1, y2, y3, y4]:</span>
<span id="cb1-12">    ax.plot(x, y, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.-'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-multiple-series-same-plot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/plots-with-multiple-y-axes/index_files/figure-html/fig-multiple-series-same-plot-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;1: A matplotlib plot with four series plotted together.</figcaption>
</figure>
</div>
</div>
</div>
<p>Note that in Figure Figure&nbsp;1 each time series has a different standard deviation, thus different ranges may be needed. This is often easily accomplished by plotting each series in a different subplots. However, subplots make it more difficult to visually compare and align series, especially when time-based. For example, see subplots here:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb2-2">y1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rnd.random() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> rnd.random() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x]</span>
<span id="cb2-3">y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rnd.random() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">33</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> rnd.random() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x]</span>
<span id="cb2-4">y3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rnd.random() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> rnd.random() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x]</span>
<span id="cb2-5">y4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rnd.random() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">27</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> rnd.random() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">180</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> x]</span>
<span id="cb2-6"></span>
<span id="cb2-7">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb2-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> y <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [y1, y2, y3, y4]:</span>
<span id="cb2-9">    ax.plot(x, y, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.-'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/plots-with-multiple-y-axes/index_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Multiple series with an offset at arbitrary x.</figcaption>
</figure>
</div>
</div>
</div>
<p>Here I have added an offset to each series. Two series, <code>y1</code> and <code>y3</code> have a change point at the same index, while the other two have a change point at slightly different <code>x</code>s. We could plot each series in a subplots, perhaps vertically stacked:</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1">series <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [y1, y2, y3, y4]</span>
<span id="cb3-2">fig, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(series), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(series)))</span>
<span id="cb3-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ix, y <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(series):</span>
<span id="cb3-4">    ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axs.flat[ix]</span>
<span id="cb3-5">    ax.plot(x, y, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.-'</span>)</span>
<span id="cb3-6">    ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'y</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-multiple-series-multiple-plots" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/plots-with-multiple-y-axes/index_files/figure-html/fig-multiple-series-multiple-plots-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Series plotted on different subplots.</figcaption>
</figure>
</div>
</div>
</div>
<p>In figure Figure&nbsp;2 you can see that each series as an offset when adding a proper range on the y axis. However, it is still a bit difficult to understand the real indexes of the offset. I would like to understand which come first and which comes later.</p>
</section>
<section id="adding-multiple-y-axes-to-matplotlib-plots" class="level1">
<h1>Adding multiple Y axes to matplotlib plots</h1>
<p>We can starting adding multiple axes by taking inspiration from the Matplotib documentation using <a href="https://matplotlib.org/stable/gallery/spines/multiple_yaxis_with_spines.html">spines</a>, <a href="https://matplotlib.org/stable/gallery/axisartist/demo_parasite_axes.html">Parasite Axes</a> and another <a href="https://matplotlib.org/stable/gallery/axisartist/demo_parasite_axes2.html">Parasite axis</a> demo.</p>
<p>The idea is to use <code>ax.twinx()</code> to create an additional axes. As the <a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.twinx.html#matplotlib.axes.Axes.twinx">documentation says</a>, &gt; Create a new Axes with an invisible x-axis and an independent y-axis positioned opposite to the original one (i.e.&nbsp;at right).</p>
<p>Although <code>twinx()</code> is used to create a secondary axis on the right position I could use it to create a secondary axis and leave the spines of the axis only on the left. I can use <code>set_position()</code> on the spines object to shift the spines on left:</p>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1">fig, ax1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb4-2">ax2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax1.twinx()</span>
<span id="cb4-3">ax3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax1.twinx()</span>
<span id="cb4-4">ax4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax1.twinx()</span>
<span id="cb4-5">axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [ax1, ax2, ax3, ax4]</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ix, (ax, y) <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(axs, series)):</span>
<span id="cb4-8">    ax.plot(x, y, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'y</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb4-9">ax.legend()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-single-plot-bare-twinx" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://grigolet.github.io/posts/plots-with-multiple-y-axes/index_files/figure-html/fig-single-plot-bare-twinx-output-1.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;3: Single plot with multiple series and secondary axes.</figcaption>
</figure>
</div>
</div>
</div>
<p>As you can see in Figure Figure&nbsp;3 we can understand the index at which each change point of the series is happening. The only issue is that the y axes on the right are overlapping between each other.</p>
<p>My goal is to have these secondary y-axes on the left for easier reading. Actually, if you inspect the source of how <code>twinx()</code> is defined, it calls <code>Axes._make_twin_axes()</code> and sets later the tick position on the right using <code>YAxis.tick_right()</code> and <code>YAxis.set_label_position('right')</code>. It would be nice if <code>twinx()</code> would not assume that we want the axes to the right and instead allowed to pass a parameter which decised the position.</p>
<p>Here below I leave a minimum working example I could think of:</p>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb5-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ix, y <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(series):</span>
<span id="cb5-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If we have to plot the first series we use </span></span>
<span id="cb5-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The axes created by plt.subplots() earlier</span></span>
<span id="cb5-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: </span>
<span id="cb5-6">        ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes</span>
<span id="cb5-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb5-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># It's not the first series: we need to</span></span>
<span id="cb5-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create a twin axes</span></span>
<span id="cb5-10">        ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes.twinx()</span>
<span id="cb5-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the ticks of the axis to the left</span></span>
<span id="cb5-12">    ax.yaxis.tick_left()</span>
<span id="cb5-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the labels of the axes to the lef</span></span>
<span id="cb5-14">    ax.yaxis.set_label_position(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>)</span>
<span id="cb5-15">    ax.yaxis.set_offset_position(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>)</span>
<span id="cb5-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Offset the position of he ticks and labels</span></span>
<span id="cb5-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># by some % of the axes avoid overlapping of axes</span></span>
<span id="cb5-18">    ax.spines[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>].set_position((<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'outward'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ix))</span>
<span id="cb5-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the actual data</span></span>
<span id="cb5-20">    ax.plot(x, y, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb5-21">    ax.spines[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>].set_color(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb5-22">    ax.tick_params(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>, colors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/plots-with-multiple-y-axes/index_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Et voilà, here I have a plot similar to the WinCC-OA one. I could improve the plot a bit by using the same number of ticks for each axes. I would do this using the <code>LinearLocator</code> class:</p>
<div class="cell" data-execution_count="59">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.ticker <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> mt</span>
<span id="cb6-2"></span>
<span id="cb6-3">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb6-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ix, y <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(series):</span>
<span id="cb6-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If we have to plot the first series we use </span></span>
<span id="cb6-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The axes created by plt.subplots() earlier</span></span>
<span id="cb6-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>: </span>
<span id="cb6-8">        ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes</span>
<span id="cb6-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb6-10">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># It's not the first series: we need to</span></span>
<span id="cb6-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create a twin axes</span></span>
<span id="cb6-12">        ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes.twinx()</span>
<span id="cb6-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the ticks of the axis to the left</span></span>
<span id="cb6-14">    ax.yaxis.tick_left()</span>
<span id="cb6-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the labels of the axes to the left</span></span>
<span id="cb6-16">    ax.yaxis.set_label_position(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>)</span>
<span id="cb6-17">    ax.yaxis.set_offset_position(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>)</span>
<span id="cb6-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Offset the position of he ticks and labels</span></span>
<span id="cb6-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># by some % of the axes avoid overlapping of axes</span></span>
<span id="cb6-20">    ax.spines[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>].set_position((<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'outward'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ix))</span>
<span id="cb6-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the actual data</span></span>
<span id="cb6-22">    ax.plot(x, y, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb6-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the colors of the ticks, labels and spines to be</span></span>
<span id="cb6-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the same of the associated series</span></span>
<span id="cb6-25">    ax.spines[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'left'</span>].set_color(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb6-26">    ax.tick_params(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'y'</span>, colors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'C</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb6-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use a tick locator to have the same number of ticks</span></span>
<span id="cb6-28">    ax.yaxis.set_major_locator(mt.LinearLocator(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>))</span>
<span id="cb6-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># And format the labels to have only one digit after the decimals</span></span>
<span id="cb6-30">    ax.yaxis.set_major_formatter(mt.StrMethodFormatter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{x:.1f}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>))</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/plots-with-multiple-y-axes/index_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="conclusions" class="level1">
<h1>Conclusions</h1>
<p>I find very useful for myself to provide a minimal example of having a plot with multiple axes, though a final plot may require more subtle adjustements. Keypoints to have multiple y axes:</p>
<ul>
<li>Use <code>twinx()</code> to create an additional axis</li>
<li>Set ticks, labels and offest positions to the right: <code>ax.yaxis.tick_left()</code>, <code>ax.yaxis.set_label_position('left')</code>, <code>ax.yaxis.set_offset_position('left')</code></li>
<li>Adjust the offset of the spines to the left using points, percentage or data coordinate. In the case of points: <code>ax.spines['left'].set_position()</code></li>
<li>Change spines, tick and label colors to the same of the series for better readability: <code>ax.spines['left'].set_color(color)</code>, <code>ax.tick_params(axis='y', colors=color)</code></li>
<li>Optionally adjust the number of ticks to be the same for all the axes: use a <code>LinearLocator</code> class with a fixed number of points</li>
</ul>


</section>

 ]]></description>
  <category>python</category>
  <category>matplotlib</category>
  <category>plot</category>
  <category>visualization</category>
  <guid>https://grigolet.github.io/posts/plots-with-multiple-y-axes/index.html</guid>
  <pubDate>Wed, 07 Sep 2022 22:00:00 GMT</pubDate>
  <media:content url="https://grigolet.github.io/posts/plots-with-multiple-y-axes/preview.png" medium="image" type="image/png" height="72" width="144"/>
</item>
<item>
  <title>A post made from a jupyter notebook</title>
  <dc:creator>Gianluca Rigoletti</dc:creator>
  <link>https://grigolet.github.io/posts/a-post-with-jupyter-notebook/index.html</link>
  <description><![CDATA[ 




<p>Few days ago I found <a href="https://quarto.org">Quarto</a>. I understood it is an authoring framework based on pandoc and that has full support of jupyter notebooks as input files. Since lot of work I carry on at the moment makes a heavy use of jupyter notebook I decided to try Quarto and use it for two main purposes: the first is as a replacement of <code>jupyter nbconvert</code> that I have intensively used to convert notebooks to html pages.</p>
<p>I saw that Quarto provides much more flexibility on the layout of the text, images and code, which was exactly what I was looking for. The second way I intend to use Quarto is to publish the present content. At the time of writing, this post is written on an <code>index.ipynb</code> file in my local computer using Visual Studio code. I find extremely pleasant to write mixed content and have a tool that transforms it in a post page of a blog website.</p>
<p>I will showcase here all the features that I have personally found relevant for the posts I am going to write as well, hoping that this post serves as a quick reference (together with the <a href="https://quarto.org/docs/guide/">Quarto user guide</a>).</p>
<section id="code-cells" class="level2">
<h2 class="anchored" data-anchor-id="code-cells">Code cells</h2>
<p>Code cells are pretty straightforward: I just have to write code in a cell and it will be executed and the output eventually frozen by Quarto. I found the <a href="https://quarto.org/docs/projects/code-execution.html#freeze">freeze option</a> particularly useful and I set it to <code>auto</code> at the time of writing. In this way, the notebooks will be re-rendered only if the source code changes.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd </span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span></code></pre></div>
</div>
<p>At the very base you can just enter some code and save it. If you are using <code>quarto preview</code> the jupyter notebook is executed when it saved (and not when a code cell is executed, but this depends on the saving options of jupyter).</p>
<p>For instance, we can write some code and let it display some output like this:</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> TestClass:</span>
<span id="cb2-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, params) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb2-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.attributes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params</span>
<span id="cb2-4">    </span>
<span id="cb2-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> increment(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, param: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb2-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-7"></span>
<span id="cb2-8">obj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TestClass(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>)</span>
<span id="cb2-9">obj.increment(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>11</code></pre>
</div>
</div>
<p>Sometimes a cell may contain lot of code that makes it difficult for the reader to keep track of the text. In this case folding the code is very helpful and only requires a special comment to be added at the beginning of the code cell:</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| code-fold: true</span></span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> TestClass:</span>
<span id="cb4-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, params) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb4-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.attributes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params</span>
<span id="cb4-6">    </span>
<span id="cb4-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> increment(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, param: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb4-8">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-9"></span>
<span id="cb4-10">obj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TestClass(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>)</span>
<span id="cb4-11">obj.increment(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<p>Here below the result of the previous snippet of code:</p>
<div class="cell" data-execution_count="3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> TestClass:</span>
<span id="cb5-2">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, params) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb5-3">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.attributes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params</span>
<span id="cb5-4">    </span>
<span id="cb5-5">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> increment(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, param: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>:</span>
<span id="cb5-6">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb5-7"></span>
<span id="cb5-8">obj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TestClass(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>)</span>
<span id="cb5-9">obj.increment(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>11</code></pre>
</div>
</div>
<p>Note that the output of the cell is not folded. This is particularly useful if you have lot of code printing out a plot for example: the code will be folded but the plot will be visible anyway.</p>
<p>Some other time I wish to completely hide the code while keeping the output visible. In this case the option <code>echo: false</code> does the job:</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| echo: false</span></span>
<span id="cb7-2">plt.plot([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ro'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<p>Here below the result of the previous snippet of code:</p>
<div class="cell" data-execution_count="4">
<div class="cell-output cell-output-display">
<p><img src="https://grigolet.github.io/posts/a-post-with-jupyter-notebook/index_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Code cells can be also assigned a file name. This is particularly helpful when there is a post that needs to tackle code among several files. As an example you can have something like:</p>
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| filename: test.py</span></span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> A:</span>
<span id="cb8-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span></code></pre></div>
<p>And this would be rendered to:</p>
<div class="cell" data-execution_count="5">
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>test.py</strong></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> A:</span>
<span id="cb9-2">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">pass</span></span></code></pre></div>
</div>
</div>
</section>
<section id="controlling-figures-layout" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="controlling-figures-layout">Controlling figures layout</h2>
<p>I find particularly useful the way Quarto helps treating outputs for code cells, especially laying out figures resulting from a code output. Often times I have big plots that I would like to take all the available horizontal space in the page. In this case I can use <code>#| column: page</code> together with on the code cell</p>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| column: page</span></span>
<span id="cb10-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| fig-align: center</span></span>
<span id="cb10-3">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>)</span>
<span id="cb10-4">ax.plot(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">31</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span></code></pre></div>
<div class="cell page-columns page-full" data-execution_count="7">
<div class="cell-output cell-output-display column-page">
<p><img src="https://grigolet.github.io/posts/a-post-with-jupyter-notebook/index_files/figure-html/cell-7-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>There is also support for custom layouts when multiple plots are produced. I typically use matplotlib APIs to lay out multiple plots but this features could be useful for images in general and sometimes with libraries where the layout support for subplots is not straightforward. As an example see this snippet:</p>
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#| layout-ncol: 2</span></span>
<span id="cb11-2"></span>
<span id="cb11-3">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb11-4">ax.plot([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ro-'</span>)</span>
<span id="cb11-5"></span>
<span id="cb11-6">fig2, ax2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb11-7">ax2.plot([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b*--'</span>)</span></code></pre></div>
<div class="cell quarto-layout-panel" data-execution_count="23">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="https://grigolet.github.io/posts/a-post-with-jupyter-notebook/index_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<p><img src="https://grigolet.github.io/posts/a-post-with-jupyter-notebook/index_files/figure-html/cell-8-output-2.png" class="img-fluid"></p>
</div>
</div>
</div>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>There are several more features that I think I will be using throughout my journey on this blog. There are also some features related to publications that I want to explore as I would like to understand if I can have some publications ready LaTeX documents from jupyter notebooks</p>
<p>I found Quarto really easy to use and <a href="https://quarto.org/docs/guide/">the documentation</a> is fairly straightforward to follow. I hope to post more interesting findings and customization as I will use it :)</p>


</section>

 ]]></description>
  <category>jupyter</category>
  <category>notebook</category>
  <category>python</category>
  <category>quarto</category>
  <guid>https://grigolet.github.io/posts/a-post-with-jupyter-notebook/index.html</guid>
  <pubDate>Tue, 06 Sep 2022 22:00:00 GMT</pubDate>
</item>
</channel>
</rss>
